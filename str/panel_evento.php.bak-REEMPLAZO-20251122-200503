<?php
session_start();

if (empty($_SESSION['usuario'])) {
    header('Location: admin.php');
    exit;
}

$dbFile = __DIR__ . '/save_the_rave.sqlite';
try {
    $pdo = new PDO('sqlite:' . $dbFile);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (Throwable $e) {
    http_response_code(500);
    echo "Error DB: " . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8');
    exit;
}

// Usuario
$stmtUser = $pdo->prepare("
    SELECT id, username, tipo_global
    FROM usuarios_admin
    WHERE username = :u
    LIMIT 1
");
$stmtUser->execute([':u' => $_SESSION['usuario']]);
$user = $stmtUser->fetch(PDO::FETCH_ASSOC);

// Sólo super_admin o admin_evento (más adelante afinamos por evento)
if (!$user || !in_array($user['tipo_global'], ['super_admin', 'admin_evento'], true)) {
    header('Location: admin.php');
    exit;
}

// ID de evento
$eventoId = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($eventoId <= 0) {
    http_response_code(400);
    echo "ID de evento inválido.";
    exit;
}

// Cargar evento
$stmtEv = $pdo->prepare("
    SELECT id, nombre, slug, descripcion, flyer_filename, fecha_desde, fecha_hasta
    FROM eventos
    WHERE id = :id
    LIMIT 1
");
$stmtEv->execute([':id' => $eventoId]);
$evento = $stmtEv->fetch(PDO::FETCH_ASSOC);

if (!$evento) {
    http_response_code(404);
    echo "Evento no encontrado.";
    exit;
}

// Stats de entradas
$total = 0;
$checkins = 0;
$faltan = 0;

// De momento SOLO STR (slug = 'str') usa la tabla 'entradas' real
if ($evento['slug'] === 'str' || $evento['id'] === 1) {
    try {
        $total    = (int)$pdo->query("SELECT COUNT(*) FROM entradas")->fetchColumn();
        $checkins = (int)$pdo->query("SELECT COUNT(*) FROM entradas WHERE checked_in = 1")->fetchColumn();
        $faltan   = max(0, $total - $checkins);
    } catch (Throwable $e) {
        // Si falla algo en 'entradas', dejamos 0/0/0
    }
}

function e($s) {
    return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8');
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel evento – <?php echo e($evento['nombre']); ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin:0;
      padding:16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#020617;
      color:#e5e7eb;
    }
    h1 {
      font-size:1.4rem;
      margin:0 0 4px;
    }
    .sub {
      font-size:0.85rem;
      color:#9ca3af;
      margin-bottom:12px;
    }
    .btn-link {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:#111827;
      color:#e5e7eb;
      text-decoration:none;
      font-size:0.8rem;
      margin-right:8px;
      border:1px solid #1f2937;
    }
    .btn-link:hover { background:#1f2937; }
    .top-bar {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    .event-box {
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
      margin-bottom:16px;
    }
    .flyer {
      max-width:160px;
      border-radius:10px;
      border:1px solid #1f2937;
    }
    .small {
      font-size:0.8rem;
      color:#9ca3af;
    }
    .cards {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:8px;
      margin-bottom:10px;
    }
    .card {
      background:#020617;
      border-radius:14px;
      padding:14px 16px;
      border:1px solid #1f2937;
      box-shadow:0 10px 25px rgba(0,0,0,0.5);
      flex:1 1 220px;
    }
    .card-title {
      font-size:0.85rem;
      color:#9ca3af;
      margin-bottom:4px;
    }
    .card-value {
      font-size:1.6rem;
      font-weight:700;
      margin-bottom:2px;
    }
    .card-desc {
      font-size:0.8rem;
      color:#6b7280;
    }
    .msg-info {
      margin-top:8px;
      padding:8px 10px;
      border-radius:8px;
      background:#111827;
      color:#e5e7eb;
      font-size:0.8rem;
    }
  </style>
</head>
<body>

<div>
  <a class="btn-link" href="admin.php">⬅ Volver al panel principal</a>
  <a class="btn-link" href="eventos.php">Ver todos los eventos</a>
  <a class="btn-link" href="crear_evento.php">Crear nuevo evento</a>
  <a class="btn-link" href="editar_evento.php?id=<?php echo (int)$evento['id']; ?>">Editar este evento</a>
  <?php if ($user['tipo_global'] === 'super_admin'): ?>
    <a class="btn-link" href="superadmin.php">SuperAdmin</a>
  <?php endif; ?>
</div>

<div class="top-bar">
  <div>
    <h1>Panel evento – <?php echo e($evento['nombre']); ?></h1>
    <div class="sub">
      Usuario: <strong><?php echo e($user['username']); ?></strong>
      (<?php echo e($user['tipo_global']); ?>)<br>
      Slug: <code><?php echo e($evento['slug']); ?></code>
    </div>
  </div>
</div>

<div class="event-box">
  <?php if (!empty($evento['flyer_filename']) && file_exists(__DIR__ . '/' . $evento['flyer_filename'])): ?>
    <div>
      <img src="<?php echo e($evento['flyer_filename']); ?>" alt="Flyer evento" class="flyer">
    </div>
  <?php endif; ?>

  <div class="small">
    <?php if (!empty($evento['fecha_desde']) || !empty($evento['fecha_hasta'])): ?>
      <div>
        <strong>Fecha(s):</strong>
        <?php echo e($evento['fecha_desde'] ?: 'sin definir'); ?>
        <?php if (!empty($evento['fecha_hasta'])): ?>
          &nbsp;→&nbsp;<?php echo e($evento['fecha_hasta']); ?>
        <?php endif; ?>
      </div>
    <?php else: ?>
      <div><strong>Fecha(s):</strong> sin definir</div>
    <?php endif; ?>

    <?php if (!empty($evento['descripcion'])): ?>
      <div style="margin-top:6px;"><?php echo nl2br(e($evento['descripcion'])); ?></div>
    <?php endif; ?>
  </div>
</div>

<div class="cards">
  <div class="card">
    <div class="card-title">Entradas totales</div>
    <div class="card-value"><?php echo (int)$total; ?></div>
    <div class="card-desc">
      <?php if ($evento['slug'] === 'str' || $evento['id'] === 1): ?>
        Entradas registradas en este evento (tabla entradas).
      <?php else: ?>
        Por ahora este evento no tiene entradas vinculadas en este entorno.
      <?php endif; ?>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Check-ins realizados</div>
    <div class="card-value"><?php echo (int)$checkins; ?></div>
    <div class="card-desc">
      Entradas marcadas como utilizadas.
    </div>
  </div>

  <div class="card">
    <div class="card-title">Faltan por escanear</div>
    <div class="card-value"><?php echo (int)$faltan; ?></div>
    <div class="card-desc">
      Entradas pendientes de ingreso.
    </div>
  </div>
</div>

<div class="msg-info">
  Próximos pasos en este panel:
  <ul>
    <li>Agregar configuración detallada de tipos de entrada para este evento.</li>
    <li>Asociar entradas de compra (Tickex real) a este evento.</li>
    <li>Replicar filtros y listado de admin.php, pero filtrado por evento.</li>
  </ul>
</div>

</body>
</html>
