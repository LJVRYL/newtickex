<?php
require_once __DIR__.'/inc/bootstrap.php';
$title = "Entradas preferidas";

require_login();

$cu = current_user();
$tipoGlobal = isset($_SESSION['tipo_global']) ? $_SESSION['tipo_global'] : (isset($cu['rol'])?$cu['rol']:'');
$adminId    = isset($_SESSION['user_id']) ? (int)$_SESSION['user_id'] : 0;

if (!in_array($tipoGlobal, array('admin_evento','super_admin','superadmin'), true)) {
    abort_404("No tenés permiso para esta sección.");
}

$pdo = db();

function cat_label($c){
    switch($c){
        case 'staff': return 'Staff';
        case 'invitados': return 'Invitados';
        case 'especiales': return 'Especiales';
        case 'generales': return 'Generales';
        case 'prensa': return 'Prensa';
        case 'sponsors': return 'Sponsors';
        case 'revendedor': return 'Revendedor';
        case 'cortesia': return 'Cortesía';
        default: return ucfirst($c);
    }
}

$categorias = array(
    'staff' => 'Staff',
    'invitados' => 'Invitados',
    'especiales' => 'Invitados especiales / Especiales',
    'generales' => 'Generales',
    'cortesia' => 'Cortesías',
    'prensa' => 'Prensa',
    'sponsors' => 'Sponsors',
    'revendedor' => 'Revendedores'
);

$error = '';
$okMsg = '';

$action = isset($_POST['action']) ? $_POST['action'] : '';
if ($action === 'create' || $action === 'update') {

    $pid       = (int)(isset($_POST['id']) ? $_POST['id'] : 0);
    $nombre    = trim(isset($_POST['nombre']) ? $_POST['nombre'] : '');
    $categoria = trim(isset($_POST['categoria']) ? $_POST['categoria'] : 'generales');
    $tipo      = trim(isset($_POST['tipo']) ? $_POST['tipo'] : 'free');
    $precio    = (int)(isset($_POST['precio_default']) ? $_POST['precio_default'] : 0);
    $horaLim   = trim(isset($_POST['hora_limite_default']) ? $_POST['hora_limite_default'] : '');
    $activo    = (int)(isset($_POST['activo']) ? $_POST['activo'] : 1);
    $reglas    = trim(isset($_POST['reglas_default']) ? $_POST['reglas_default'] : '');

    if ($nombre === '') $error = "El nombre es obligatorio.";
    if (!isset($categorias[$categoria])) $error = "Categoría inválida.";
    if ($tipo !== 'free' && $tipo !== 'paga') $error = "Tipo inválido.";

    // SOLO HORA: validamos HH:MM si viene algo
    if ($horaLim !== '' && !preg_match('/^\d{2}:\d{2}$/', $horaLim)) {
        $error = "Hora límite inválida (usar HH:MM).";
    }

    if ($error === '') {
        if ($action === 'create') {
            if ($tipo === 'free') $precio = 0;
            $stmt = $pdo->prepare("
                INSERT INTO plantillas_entrada
                (admin_id, nombre, categoria, tipo, precio_default, hora_limite_default, reglas_default, activo)
                VALUES
                (:aid,:n,:c,:t,:p,:h,:r,:a)
            ");
            $stmt->execute(array(
                ':aid'=>$adminId,
                ':n'=>$nombre,
                ':c'=>$categoria,
                ':t'=>$tipo,
                ':p'=>$precio,
                ':h'=>($horaLim!==''?$horaLim:null),
                ':r'=>($reglas!==''?$reglas:null),
                ':a'=>$activo
            ));
            $okMsg = "Plantilla creada.";
        }

        if ($action === 'update') {
            // check ownership (admin) unless super
            if ($tipoGlobal === 'admin_evento') {
                $chk = $pdo->prepare("SELECT admin_id FROM plantillas_entrada WHERE id=?");
                $chk->execute(array($pid));
                $own = (int)$chk->fetchColumn();
                if ($own !== $adminId) abort_404("No podés editar esta plantilla.");
            }

            if ($tipo === 'free') $precio = 0;
            $stmt = $pdo->prepare("
                UPDATE plantillas_entrada
                SET nombre=:n, categoria=:c, tipo=:t, precio_default=:p,
                    hora_limite_default=:h, reglas_default=:r, activo=:a
                WHERE id=:id
            ");
            $stmt->execute(array(
                ':n'=>$nombre,
                ':c'=>$categoria,
                ':t'=>$tipo,
                ':p'=>$precio,
                ':h'=>($horaLim!==''?$horaLim:null),
                ':r'=>($reglas!==''?$reglas:null),
                ':a'=>$activo,
                ':id'=>$pid
            ));
            $okMsg = "Plantilla actualizada.";
        }
    }
}

// delete
if (isset($_GET['del'])) {
    $delId = (int)$_GET['del'];

    if ($tipoGlobal === 'admin_evento') {
        $chk = $pdo->prepare("SELECT admin_id FROM plantillas_entrada WHERE id=?");
        $chk->execute(array($delId));
        $own = (int)$chk->fetchColumn();
        if ($own !== $adminId) abort_404("No podés eliminar esta plantilla.");
    }

    $pdo->prepare("DELETE FROM plantillas_entrada WHERE id=?")->execute(array($delId));
    header("Location: plantillas_entrada.php");
    exit;
}

// edit load
$editRow = null;
if (isset($_GET['edit'])) {
    $editId = (int)$_GET['edit'];
    $stmtE = $pdo->prepare("SELECT * FROM plantillas_entrada WHERE id=? LIMIT 1");
    $stmtE->execute(array($editId));
    $editRow = $stmtE->fetch(PDO::FETCH_ASSOC);

    if (!$editRow) abort_404("Plantilla no encontrada.");
    if ($tipoGlobal === 'admin_evento' && (int)$editRow['admin_id'] !== $adminId) {
        abort_404("No podés editar esta plantilla.");
    }
}

// list rows
if ($tipoGlobal === 'super_admin' || $tipoGlobal === 'superadmin') {
    $rows = $pdo->query("SELECT * FROM plantillas_entrada ORDER BY id DESC")->fetchAll(PDO::FETCH_ASSOC);
} else {
    $stmtL = $pdo->prepare("SELECT * FROM plantillas_entrada WHERE admin_id=? ORDER BY id DESC");
    $stmtL->execute(array($adminId));
    $rows = $stmtL->fetchAll(PDO::FETCH_ASSOC);
}

include __DIR__.'/inc/layout_top.php';
?>

<div class="card" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
  <a class="btn secondary" href="panel_admin.php">⬅ Volver al panel</a>
  <span style="flex:1 1 auto;"></span>
  <a class="btn danger" href="login.php?logout=1">Salir</a>
</div>

<div class="card">
  <h2>Entradas preferidas (plantillas)</h2>
  <div style="color:var(--muted);font-size:14px;margin-top:4px;">
    Estas plantillas son tuyas y las podés reutilizar en todos tus eventos.
  </div>

  <?php if($error): ?>
    <div class="flash err" style="margin-top:10px;"><?php echo e($error); ?></div>
  <?php endif; ?>
  <?php if($okMsg): ?>
    <div class="flash ok" style="margin-top:10px;"><?php echo e($okMsg); ?></div>
  <?php endif; ?>

  <form method="post" style="margin-top:12px;">
    <input type="hidden" name="action" value="<?php echo $editRow?'update':'create'; ?>">
    <?php if($editRow): ?>
      <input type="hidden" name="id" value="<?php echo (int)$editRow['id']; ?>">
    <?php endif; ?>

    <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px;">
      <div>
        <label>Nombre</label>
        <input name="nombre" required
          value="<?php echo e($editRow? $editRow['nombre'] : ''); ?>"
          placeholder="Ej: General, Invitados, Staff, etc.">
      </div>

      <div>
        <label>Categoría</label>
        <select name="categoria">
          <?php foreach($categorias as $k=>$lab): ?>
            <?php $sel = ($editRow && $editRow['categoria']===$k)?'selected':''; ?>
            <option value="<?php echo e($k); ?>" <?php echo $sel; ?>><?php echo e($lab); ?></option>
          <?php endforeach; ?>
        </select>
      </div>

      <div>
        <label>Tipo</label>
        <?php $tSel = $editRow? $editRow['tipo'] : 'free'; ?>
        <select name="tipo">
          <option value="free" <?php if($tSel==='free') echo 'selected'; ?>>FREE</option>
          <option value="paga" <?php if($tSel==='paga') echo 'selected'; ?>>PAGA</option>
        </select>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px;">
      <div>
        <label>Precio default (si paga)</label>
        <input type="number" min="0" step="1" name="precio_default"
          value="<?php echo e($editRow? (int)$editRow['precio_default'] : 0); ?>">
      </div>

      <div>
        <label>Hora límite default (HH:MM)</label>
        <input type="time" name="hora_limite_default"
          value="<?php echo e($editRow? (string)$editRow['hora_limite_default'] : ''); ?>">
      </div>

      <div>
        <label>Estado</label>
        <?php $aSel = $editRow? (int)$editRow['activo'] : 1; ?>
        <select name="activo">
          <option value="1" <?php if($aSel===1) echo 'selected'; ?>>Activa</option>
          <option value="0" <?php if($aSel===0) echo 'selected'; ?>>Inactiva</option>
        </select>
      </div>
    </div>

    <div style="margin-top:8px;">
      <label>Reglas (futuro promos / tandas)</label>
      <textarea name="reglas_default" rows="3"
        placeholder='JSON / texto libre (por ahora no se usa)'><?php echo e($editRow? (string)$editRow['reglas_default'] : ''); ?></textarea>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;">
      <button class="btn" type="submit">
        <?php echo $editRow? 'Guardar cambios' : 'Crear plantilla'; ?>
      </button>
      <?php if($editRow): ?>
        <a class="btn secondary" href="plantillas_entrada.php">Cancelar</a>
      <?php endif; ?>
    </div>
  </form>
</div>

<div class="card">
  <h3>Mis plantillas</h3>

  <?php if(!$rows): ?>
    <div style="color:var(--muted);font-size:14px;">No
  <?php else: ?>
    <table class="table" style="margin-top:8px;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Tipo</th>
          <th>Precio</th>
          <th>Hora límite</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <?php foreach($rows as $r): ?>
          <tr>
            <td><?php echo (int)$r['id']; ?></td>
            <td><?php echo e($r['nombre']); ?></td>
            <td><?php echo e(cat_label($r['categoria'])); ?></td>
            <td><?php echo e(strtoupper($r['tipo'])); ?></td>
            <td><?php echo (int)$r['precio_default']; ?></td>
            <td><?php echo e($r['hora_limite_default']); ?></td>
            <td><?php echo ((int)$r['activo']===1) ? 'Activa' : 'Inactiva'; ?></td>
            <td style="white-space:nowrap;">
              <a class="btn secondary" style="padding:6px 10px;font-size:12px;" href="plantillas_entrada.php?edit=<?php echo (int)$r['id']; ?>">Editar</a>
              <a class="btn danger" style="padding:6px 10px;font-size:12px;"
                 href="plantillas_entrada.php?del=<?php echo (int)$r['id']; ?>"
                 onclick="return confirm('¿Eliminar plantilla?');">✕</a>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  <?php endif; ?>
</div>

<?php include __DIR__.'/inc/layout_bottom.php'; ?>
