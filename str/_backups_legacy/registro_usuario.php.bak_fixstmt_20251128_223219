<?php
require_once __DIR__ . '/inc/bootstrap.php';
date_default_timezone_set('America/Argentina/Buenos_Aires');

//
// Función para enviar el mail de confirmación
//
function enviar_mail_confirmacion($email, $nombreCompleto, $token)
{
    $fromEmail = 'no-reply@tickex.com.ar';
    $fromName  = 'Tickex';
    $from      = $fromName . ' <' . $fromEmail . '>';

    $link    = 'https://str.tickex.com.ar/verificar_email.php?token=' . urlencode($token);
    $subject = 'Confirmá tu email en Tickex';

    $body  = "Hola " . $nombreCompleto . ",\n\n";
    $body .= "Gracias por registrarte en Tickex.\n\n";
    $body .= "Para confirmar tu email y activar tu cuenta, hacé clic en este enlace:\n";
    $body .= $link . "\n\n";
    $body .= "Si no te registraste vos, podés ignorar este mensaje.\n\n";
    $body .= "Tickex\n";

    $headers  = "From: " . $from . "\r\n";
    $headers .= "Reply-To: " . $fromEmail . "\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion() . "\r\n";

    // Envelope sender (-f) importante para algunos MTAs
    $extraParams = '-f ' . $fromEmail;

    $ok = mail($email, $subject, $body, $headers, $extraParams);

    // Log simple en archivo local
    $logLine = date('c') . " registro_usuario mail to=" . $email . " ok=" . ($ok ? '1' : '0') . "\n";
    @file_put_contents(__DIR__ . "/log_mail_registro.txt", $logLine, FILE_APPEND);

    return $ok;
}

$errores   = array();
$mensajeOk = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $nombre    = isset($_POST['nombre']) ? trim($_POST['nombre']) : '';
    $apellido  = isset($_POST['apellido']) ? trim($_POST['apellido']) : '';
    $email     = isset($_POST['email']) ? trim($_POST['email']) : '';
    $dni       = isset($_POST['dni']) ? trim($_POST['dni']) : '';
    $pass      = isset($_POST['password']) ? $_POST['password'] : '';
    $pass2     = isset($_POST['password2']) ? $_POST['password2'] : '';

    // Validaciones básicas
    if ($nombre === '') {
        $errores[] = 'El nombre es obligatorio.';
    }
    if ($apellido === '') {
        $errores[] = 'El apellido es obligatorio.';
    }
    if ($email === '') {
        $errores[] = 'El email es obligatorio.';
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $errores[] = 'El email no tiene un formato válido.';
    }
    if ($dni === '') {
        $errores[] = 'El DNI es obligatorio.';
    }
    if ($pass === '' || $pass2 === '') {
        $errores[] = 'Tenés que completar la contraseña en ambos campos.';
    } elseif ($pass !== $pass2) {
        $errores[] = 'Las contraseñas no coinciden.';
    }

    if (empty($errores)) {
        try {
            $pdo = db();
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

            // ¿Ya existe un usuario con ese email?
            $st = $pdo->prepare("SELECT id FROM usuarios WHERE email = :email LIMIT 1");
            $st->execute(array(':email' => $email));
            if ($st->fetch(PDO::FETCH_ASSOC)) {
                $errores[] = 'Ya existe un usuario registrado con ese email.';
            }
        } catch (Exception $e) {
            $errores[] = 'Error de base de datos (verificar email duplicado).';
        }
    }

    if (empty($errores)) {
        try {
            $pdo = db();
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

            // Generar hash de contraseña
            $passwordHash = password_hash($pass, PASSWORD_DEFAULT);

            // Generar token de confirmación
            if (function_exists('random_bytes')) {
                $token = bin2hex(random_bytes(16));
            } else {
                $token = sha1(uniqid(mt_rand(), true));
            }

            $ahora = date('Y-m-d H:i:s');

            $sql = "
                INSERT INTO usuarios
                    (nombre, apellido, email, dni, password_hash, rol, email_confirmado, token_confirmacion, creado_en)
                VALUES
                    (:nombre, :apellido, :email, :dni, :pass, 'cliente', 0, :token, :creado_en)
            ";
            $stm
            $stmt->execute(array(
                ':nombre'    => $nombre,
                ':apellido'  => $apellido,
                ':email'     => $email,
                ':dni'       => $dni,
                ':pass'      => $passwordHash,
                ':token'     => $token,
                ':creado_en' => $ahora,
            ));

            $nombreCompleto = trim($nombre . ' ' . $apellido);
            $mailOk = enviar_mail_confirmacion($email, $nombreCompleto, $token);

            $mensajeOk = 'Te enviamos un email de confirmación a ' . htmlspecialchars($email, ENT_QUOTES, 'UTF-8') . '.';

        } catch (Exception $e) {
            $errores[] = 'Error al registrar el usuario: ' . $e->getMessage();
        }
    }
}

$title = "Registro de usuario";
include __DIR__ . '/inc/layout_top.php';
?>
<div class="card" style="text-align:center;margin-bottom:16px;">
  <img src="tickex-logo_sobre_oscuro.svg"
       alt="Tickex"
       style="height:230px;display:block;margin:0 auto 12px auto;">
  <h2>Crear cuenta en Tickex</h2>
  <p style="color:var(--muted);max-width:480px;margin:0 auto;">
    Registrate para poder recibir tus entradas por email y gestionar tus compras en Tickex.
  </p>
</div>

<?php if (!empty($errores)): ?>
  <div class="card" style="border-left:4px solid #ff5555;">
    <h3>Hay errores en el formulario</h3>
    <ul>
      <?php foreach ($errores as $e): ?>
        <li><?php echo htmlspecialchars($e, ENT_QUOTES, 'UTF-8'); ?></li>
      <?php endforeach; ?>
    </ul>
  </div>
<?php endif; ?>

<?php if ($mensajeOk !== ''): ?>
  <div class="card" style="border-left:4px solid #33aa33;">
    <h3>Revisá tu email</h3>
    <p>
      Creamos tu usuario con el rol <strong>cliente</strong>.<br>
      <?php echo htmlspecialchars($mensajeOk, ENT_QUOTES, 'UTF-8'); ?>
    </p>
    <p style="color:var(--muted);font-size:14px;">
      Si no ves el mail en unos minutos, revisá la carpeta de spam / correo no deseado.
    </p>
  </div>
<?php else: ?>
  <form method="post" class="card" style="max-width:480px;margin:0 auto;">
    <h3>Datos de tu cuenta</h3>

    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" name="nombre" required
           value="<?php echo isset($nombre) ? htmlspecialchars($nombre, ENT_QUOTES, 'UTF-8') : ''; ?>">

    <label for="apellido">Apellido</label>
    <input type="text" id="apellido" name="apellido" required
           value="<?php echo isset($apellido) ? htmlspecialchars($apellido, ENT_QUOTES, 'UTF-8') : ''; ?>">

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required
           value="<?php echo isset($email) ? htmlspecialchars($email, ENT_QUOTES, 'UTF-8') : ''; ?>">

    <label for="dni">DNI</label>
    <input type="text" id="dni" name="dni" required
           value="<?php echo isset($dni) ? htmlspecialchars($dni, ENT_QUOTES, 'UTF-8') : ''; ?>">

    <label for="password">Contraseña</label>
    <input type="password" id="password" name="password" required>

    <label for="password2">Repetir contraseña</label>
    <input type="password" id="password2" name="password2" required>

    <button class="btn" type="submit" style="width:100%;margin-top:16px;">Registrarme</button>
  </form>
<?php endif; ?>

<?php include __DIR__ . '/inc/layout_bottom.php'; ?>
