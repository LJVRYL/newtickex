<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);

// Mis Entradas (plantillas reutilizables) - PHP5 safe

require_once __DIR__ . '/inc/bootstrap.php';
$title = "Mis Entradas";

require_login();
$pdo = db();

function e($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }

$tipoGlobal = isset($_SESSION['tipo_global']) ? $_SESSION['tipo_global'] : '';
$adminId    = isset($_SESSION['user_id']) ? (int)$_SESSION['user_id'] : 0;

if (!in_array($tipoGlobal, array('admin_evento','super_admin'), true)) {
    abort_404("No ten√©s permiso.");
}

/* ========= TABLA ========= */
$pdo->exec("
CREATE TABLE IF NOT EXISTS plantillas_entrada (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  creado_por_admin_id INTEGER NOT NULL,
  categoria TEXT NOT NULL,
  nombre TEXT NOT NULL,
  tipo TEXT NOT NULL,
  precio_default INTEGER NOT NULL DEFAULT 0,
  cantidad_default INTEGER NOT NULL DEFAULT 0,
  hora_limite_default TEXT NULL,
  descripcion TEXT NULL,
  activo INTEGER NOT NULL DEFAULT 1,
  creado_en TEXT NOT NULL DEFAULT (datetime('now'))
);
");

/* ========= BASE ========= */
$catFijas = array('Staff','Invitados','Generales','Prensa','Sponsors','Revendedores');
$tiposAll = array('FREE','PAGA','PREPAGA','PUERTA');

function normalizar_cat($c){
    $c = trim($c);
    if ($c==='') return '';
    return ucfirst(strtolower($c));
}

function validar_categoria_tipo($categoria, $tipo){
    $cat = strtolower($categoria);
    $t   = strtoupper($tipo);

    if ($cat==='staff' && $t!=='FREE') return "Staff solo permite FREE.";
    if ($cat==='prensa' && $t!=='FREE') return "Prensa solo permite FREE.";
    if ($cat==='generales' && $t==='FREE') return "Generales no permite FREE.";
    if ($cat==='sponsors' && $t==='PUERTA') return "Sponsors no permite PUERTA.";
    return "";
}

/* ========= ELIMINAR PLANTILLA ========= */
if (isset($_GET['del_id'])) {
    $delId = (int)$_GET['del_id'];

    $st = $pdo->prepare("SELECT id, creado_por_admin_id FROM plantillas_entrada WHERE id=?");
    $st->execute(array($delId));
    $row = $st->fetch(PDO::FETCH_ASSOC);

    if (!$row) abort_404("Plantilla inexistente.");
    if ($tipoGlobal!=='super_admin' && (int)$row['creado_por_admin_id']!==$adminId) {
        abort_404("No pod√©s borrar esta plantilla.");
    }

    $pdo->prepare("DELETE FROM plantillas_entrada WHERE id=?")->execute(array($delId));
    header("Location: plantillas_entrada.php");
    exit;
}

/* ========= ELIMINAR CATEGOR√çA CUSTOM ========= */
if (isset($_GET['del_cat'])) {
    $catDel = normalizar_cat($_GET['del_cat']);

    if (in_array($catDel, $catFijas, true)) {
        abort_404("No pod√©s borrar categor√≠as fijas.");
    }

    $params = array($catDel);
    $sql = "SELECT COUNT(*) FROM plantillas_entrada WHERE categoria=? ";
    if ($tipoGlobal!=='super_admin') {
        $sql .= "AND creado_por_admin_id=? ";
        $params[] = $adminId;
    }

    $st = $pdo->prepare($sql);
    $st->execute($params);
    $uso = (int)$st->fetchColumn();

    if ($uso>0) {
        flash("No pod√©s borrar la categor√≠a porque tiene plantillas.", "err");
        header("Location: plantillas_entrada.php");
        exit;
    }

    flash("Categor√≠a eliminada.", "ok");
    header("Location: plantillas_entrada.php");
    exit;
}

/* ========= MODO EDICI√ìN ========= */
$editId = isset($_GET['edit_id']) ? (int)$_GET['edit_id'] : 0;
$editing = false;
$editRow = null;

if ($editId>0) {
    $st = $pdo->prepare("SELECT * FROM plantillas_entrada WHERE id=?");
    $st->execute(array($editId));
    $editRow = $st->fetch(PDO::FETCH_ASSOC);

    if (!$editRow) abort_404("Plantilla inexistente.");
    if ($tipoGlobal!=='super_admin' && (int)$editRow['creado_por_admin_id']!==$adminId) {
        abort_404("No pod√©s editar esta plantilla.");
    }
    $editing = true;
}

/* ========= CREAR / EDITAR ========= */
$error = '';
$okMsg = '';

if ($_SERVER['REQUEST_METHOD']==='POST') {

    $nombre = isset($_POST['nombre']) ? trim($_POST['nombre']) : '';
    $categoria = isset($_POST['categoria']) ? trim($_POST['categoria']) : '';
    $catNueva  = isset($_POST['categoria_nueva']) ? trim($_POST['categoria_nueva']) : '';

    if ($categoria==='__new__') {
        $categoria = $catNueva;
    }
    $categoria = normalizar_cat($categoria);

    $tipo = isset($_POST['tipo']) ? strtoupper(trim($_POST['tipo'])) : 'FREE';
    $precio = isset($_POST['precio']) ? (int)$_POST['precio'] : 0;
    $cantidad = isset($_POST['cantidad']) ? (int)$_POST['cantidad'] : 0;
    $hora = isset($_POST['hora_limite']) ? trim($_POST['hora_limite']) : '';
    $descripcion = isset($_POST['descripcion']) ? trim($_POST['descripcion']) : '';
    $activo = isset($_POST['activo']) ? 1 : 0;

    if ($nombre==='') $error="El nombre es obligatorio.";
    if (!$error && $categoria==='') $error="La categor√≠a es obligatoria.";
    if (!$error && !in_array($tipo, $tiposAll, true)) $error="Tipo inv√°lido.";
    if (!$error && $precio<0) $error="Precio inv√°lido.";
    if (!$error && $cantidad<0) $error="Cantidad inv√°lida.";

    if (!$error && $hora!=='') {
        if (!preg_match('/^\d{2}:\d{2}$/', $hora)) {
            $error="Hora inv√°lida (HH:MM).";
        }
    }

    if (!$error) {
        $msgRule = validar_categoria_tipo($categoria, $tipo);
        if ($msgRule!=='') $error=$msgRule;
    }

    if (!$error && $tipo==='FREE') {
        $precio = 0;
    }

    if (!$error) {
        if ($editing) {
            $st = $pdo->prepare("
                UPDATE plantillas_entrada
                SET categoria=:c, nombre=:n, tipo=:t,
                    precio_default=:p, cantidad_default=:q,
                    hora_limite_default=:h, descripcion=:d, activo=:a
                WHERE id=:id
            ");
            $st->execute(array(
                ':c'=>$categoria, ':n'=>$nombre, ':t'=>$tipo,
                ':p'=>$precio, ':q'=>$cantidad,
                ':h'=>($hora!==''?$hora:null),
                ':d'=>($descripcion!==''?$descripcion:null),
                ':a'=>$activo, ':id'=>$editId
            ));
            $okMsg="Plantilla actualizada.";
            $editing=false; $editId=0; $editRow=null;
        } else {
            $st = $pdo->prepare("
                INSERT INTO plantillas_entrada
                (creado_por_admin_id,categoria,nombre,tipo,precio_default,cantidad_default,hora_limite_default,descripcion,activo)
                VALUES
                (:aid,:c,:n,:t,:p,:q,:h,:d,:a)
            ");
            $st->execute(array(
                ':aid'=>$adminId,
                ':c'=>$categoria, ':n'=>$nombre, ':t'=>$tipo,
                ':p'=>$precio, ':q'=>$cantidad,
                ':h'=>($hora!==''?$hora:null),
                ':d'=>($descripcion!==''?$descripcion:null),
                ':a'=>$activo
            ));
            $okMsg="Plantilla creada.";
        }
    }
}

/* ========= CATEGOR√çAS DISPONIBLES ========= */
$params = array();
$sql = "SELECT DISTINCT categoria FROM plantillas_entrada ";
if ($tipoGlobal!=='super_admin') {
    $sql .= "WHERE creado_por_admin_id=? ";
    $params[] = $adminId;
}
$sql .= "ORDER BY categoria ASC";

$st = $pdo->prepare($sql);
$st->execute($params);
$catsCustom = $st->fetchAll(PDO::FETCH_COLUMN);

$catsDisponibles = $catFijas;
foreach($catsCustom as $cc){
    if ($cc && !in_array($cc, $catsDisponibles, true)) {
        $catsDisponibles[] = $cc;
    }
}

/* ========= LISTAR PLANTILLAS ========= */
$params = array();
$sql = "SELECT * FROM plantillas_entrada ";
if ($tipoGlobal!=='super_admin') {
    $sql .= "WHERE creado_por_admin_id=? ";
    $params[] = $adminId;
}
$sql .= "ORDER BY categoria ASC, nombre ASC, id DESC";

$st = $pdo->prepare($sql);
$st->execute($params);
$plantillas = $st->fetchAll(PDO::FETCH_ASSOC);

/* ========= DEFAULTS FORM ========= */
$formNombre = $editing ? $editRow['nombre'] : '';
$formCat    = $editing ? $editRow['categoria'] : '';
$formTipo   = $editing ? $editRow['tipo'] : 'FREE';
$formPrecio = $editing ? (int)$editRow['precio_default'] : 0;
$formCant   = $editing ? (int)$editRow['cantidad_default'] : 0;
$formHora   = $editing ? $editRow['hora_limite_default'] : '';
$formDesc   = $editing ? $editRow['descripcion'] : '';
$formAct    = $editing ? ((int)$editRow['activo']===1) : true;

include __DIR__.'/inc/layout_top.php';
?>

<div class="card" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
  <a class="btn secondary" href="panel_admin.php">‚¨Ö Volver al panel</a>
  <span style="flex:1 1 auto;"></span>
  <a class="btn danger" href="login.php?logout=1">Salir</a>
</div>

<div class="card">
  <h2>Mis Entradas</h2>
  <div class="muted">Estas plantillas son tuyas y las pod√©s reutilizar en todos tus eventos.</div>

  <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if($error): ?><div class="flash err"><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($error); ?></div><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endif; ?>
  <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if($okMsg): ?><div class="flash ok"><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($okMsg); ?></div><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endif; ?>

  <form method="post" style="margin-top:10px;display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:8px;align-items:end;">
    <div>
      <label>Nombre</label>
      <input name="nombre" required value="<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($formNombre); ?>">
    </div>

    <div>
      <label>Categor√≠a</label>
      <select name="categoria" id="categoriaSelect" required>
        <option value="">Eleg√≠...</option>
        <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 foreach($catsDisponibles as $c): ?>
          <option value="<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($c); ?>" <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if($c===$formCat) echo 'selected'; ?>>
            <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($c); ?>
          </option>
        <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endforeach; ?>
        <option value="__new__">+ Crear nueva categor√≠a...</option>
      </select>
      <input name="categoria_nueva" id="categoriaNueva"
             placeholder="Nombre nueva categor√≠a"
             style="display:none;margin-top:6px;">
    </div>

    <div>
      <label>Tipo</label>
      <select name="tipo" required>
        <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 foreach($tiposAll as $t): ?>
          <option value="<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($t); ?>" <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if($t===$formTipo) echo 'selected'; ?>>
            <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($t); ?>
          </option>
        <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endforeach; ?>
      </select>
    </div>

    <div>
      <label>Precio default</label>
      <input type="number" min="0" step="1" name="precio" value="<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo (int)$formPrecio; ?>">
    </div>

    <div>
      <label>Cantidad default</label>
      <input type="number" min="0" step="1" name="cantidad" value="<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo (int)$formCant; ?>">
    </div>

    <div>
      <label>Hora l√≠mite</label>
      <input type="time" name="hora_limite" value="<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($formHora); ?>">
    </div>

    <div style="grid-column:1 / -1;">
      <label>Descripci√≥n (texto libre)</label>
      <textarea name="descripcion" rows="2"><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($formDesc); ?></textarea>
    </div>

    <div style="grid-column:1 / -1;display:flex;gap:10px;align-items:center;">
      <label style="margin:0;display:flex;gap:6px;align-items:center;">
        <input type="checkbox" name="activo" <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if($formAct) echo 'checked'; ?>>
        Activa
      </label>

      <span style="flex:1 1 auto;"></span>

      <button class="btn secondary" type="submit">
        <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo $editing ? "Guardar cambios" : "Crear plantilla"; ?>
      </button>

      <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if($editing): ?>
        <a class="btn danger" href="plantillas_entrada.php">Cancelar</a>
      <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endif; ?>
    </div>
  </form>
</div>

<div class="card">
  <h3>Mis categor√≠as</h3>
  <div class="muted">Solo pod√©s borrar categor√≠as personalizadas que no tengan plantillas.</div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
    <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);

      $catsSoloCustom = array();
      foreach($catsCustom as $cc){
        if ($cc && !in_array($cc, $catFijas, true)) $catsSoloCustom[] = $cc;
      }
    ?>
    <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if(empty($catsSoloCustom)): ?>
      <div class="muted">No ten√©s categor√≠as personalizadas todav√≠a.</div>
    <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 else: ?>
      <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 foreach($catsSoloCustom as $cc): ?>
        <div style="display:flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:var(--panel-2);">
          <span><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($cc); ?></span>
          <a class="btn danger"
             style="padding:4px 8px;font-size:12px;"
             href="plantillas_entrada.php?del_cat=<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo urlencode($cc); ?>"
             onclick="return confirm('¬øEliminar categor√≠a <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($cc); ?>?');">üóëÔ∏è</a>
        </div>
      <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endforeach; ?>
    <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endif; ?>
  </div>
</div>

<div class="card">
  <h2>Plantillas guardadas</h2>

  <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if(empty($plantillas)): ?>
    <div class="muted">Todav√≠a no creaste plantillas.</div>
  <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 else: ?>
    <table class="table" style="margin-top:8px;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Categor√≠a</th>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>Hora l√≠mite</th>
          <th>Estado</th>
          <th style="width:120px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 foreach($plantillas as $p): ?>
          <tr>
            <td><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo (int)$p['id']; ?></td>
            <td><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($p['categoria']); ?></td>
            <td><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($p['nombre']); ?></td>
            <td><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($p['tipo']); ?></td>
            <td>$<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo (int)$p['precio_default']; ?></td>
            <td><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo (int)$p['cantidad_default']; ?></td>
            <td><?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($p['hora_limite_default']); ?></td>
            <td>
              <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 if((int)$p['activo']===1): ?>
                <span class="badge-ok">Activa</span>
              <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 else: ?>
                <span class="badge-pend">Inactiva</span>
              <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endif; ?>
            </td>
            <td style="white-space:nowrap;">
              <a class="btn secondary" style="padding:6px 10px;font-size:12px;"
                 href="plantillas_entrada.php?edit_id=<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo (int)$p['id']; ?>">‚úèÔ∏è</a>

              <a class="btn danger" style="padding:6px 10px;font-size:12px;"
                 href="plantillas_entrada.php?del_id=<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo (int)$p['id']; ?>"
                 onclick="return confirm('¬øEliminar plantilla <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 echo e($p['nombre']); ?>?');">üóëÔ∏è</a>
            </td>
          </tr>
        <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endforeach; ?>
      </tbody>
    </table>
  <?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 endif; ?>
</div>

<script>
(function(){
  var sel = document.getElementById('categoriaSelect');
  var inp = document.getElementById('categoriaNueva');
  if(!sel || !inp) return;

  function toggle(){
    if(sel.value==='__new__'){
      inp.style.display='block';
      inp.required=true;
      inp.focus();
    }else{
      inp.style.display='none';
      inp.required=false;
      inp.value='';
    }
  }
  sel.addEventListener('change', toggle);
  toggle();
})();
</script>

<?php
ini_set("display_errors",1);
ini_set("display_startup_errors",1);
error_reporting(E_ALL);
 include __DIR__.'/inc/layout_bottom.php'; ?>
