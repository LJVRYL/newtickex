<?php
session_start();
date_default_timezone_set('America/Argentina/Buenos_Aires');

function e($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }

// ========================
// AUTH: solo admin_evento o super_admin
// ========================
if (empty($_SESSION['usuario'])) {
    header("Location: login.php");
    exit;
}

$tipoGlobal = (isset($_SESSION['tipo_global']) ? $_SESSION['tipo_global'] : '');
if (!($tipoGlobal === 'admin_evento' || $tipoGlobal === 'super_admin')) {
    header("Location: login.php");
    exit;
}

$adminId = (int)((isset($_SESSION['user_id']) ? $_SESSION['user_id'] : 0));
if ($adminId <= 0) {
    echo "Sesión inválida (sin user_id).";
    exit;
}

// ========================
// DB
// ========================
$dbFile = __DIR__ . '/save_the_rave.sqlite';
try {
    $pdo = new PDO('sqlite:' . $dbFile);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (Throwable $ex) {
    http_response_code(500);
    echo "Error DB: " . e($ex->getMessage());
    exit;
}

// ========================
// Evento a administrar
// ========================
$eventoId = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($eventoId <= 0) {
    echo "Evento inválido.";
    exit;
}

// obtener evento
$stmtEv = $pdo->prepare("SELECT * FROM eventos WHERE id = :id");
$stmtEv->execute([':id'=>$eventoId]);
$evento = $stmtEv->fetch(PDO::FETCH_ASSOC);

if (!$evento) {
    echo "Evento no encontrado.";
    exit;
}

// si es admin_evento, solo puede entrar a sus eventos
if ($tipoGlobal === 'admin_evento') {
    $creador = isset($evento['creado_por_admin_id']) ? (int)$evento['creado_por_admin_id'] : 0;
    if ($creador !== $adminId) {
        echo "No tenés permiso para administrar este evento.";
        exit;
    }
}

// ========================
// Acciones (undo / delete)
// ========================
if (isset($_GET['undo'])) {
    $id = (int)$_GET['undo'];
    if ($id > 0) {
        $stmtUndo = $pdo->prepare("
            UPDATE entradas
               SET checked_in = 0,
                   checked_in_at = NULL
             WHERE id = :id
               AND evento_id = :eid
        ");
        $stmtUndo->execute([':id'=>$id, ':eid'=>$eventoId]);
    }
    header("Location: panel_evento.php?id=".$eventoId);
    exit;
}

if (isset($_GET['delete'])) {
    $id = (int)$_GET['delete'];
    if ($id > 0) {
        try {
            $pdo->beginTransaction();

            // respaldo en entradas_eliminadas si existe
            $pdo->exec("
                CREATE TABLE IF NOT EXISTS entradas_eliminadas (
                    id INTEGER,
                    nombre TEXT,
                    email TEXT,
                    fecha_registro TEXT,
                    codigo TEXT,
                    checked_in INTEGER,
                    checked_in_at TEXT,
                    tipo TEXT,
                    monto_pagado INTEGER,
                    evento_id INTEGER,
                    deleted_at TEXT
                )
            ");

            $stmtBackup = $pdo->prepare("
                INSERT INTO entradas_eliminadas
                (id, nombre, email, fecha_registro, codigo, checked_in,
                 checked_in_at, tipo, monto_pagado, evento_id, deleted_at)
                SELECT id, nombre, email, fecha_registro, codigo, checked_in,
                       checked_in_at, tipo, monto_pagado, evento_id, :deleted_at
                  FROM entradas
                 WHERE id = :id
                   AND evento_id = :eid
            ");
            $stmtBackup->execute([
                ':id'=>$id,
                ':eid'=>$eventoId,
                ':deleted_at'=>date('c')
            ]);

            $stmtDel = $pdo->prepare("DELETE FROM entradas WHERE id = :id AND evento_id = :eid");
            $stmtDel->execute([':id'=>$id, ':eid'=>$eventoId]);

            $pdo->commit();
        } catch (Throwable $ex) {
            if ($pdo->inTransaction()) $pdo->rollBack();
            http_response_code(500);
            echo "Error al eliminar: " . e($ex->getMessage());
            exit;
        }
    }
    header("Location: panel_evento.php?id
    exit;
}

// ========================
// Filtros
// ========================
$q = isset($_GET['q']) ? trim($_GET['q']) : '';
$filtroTipo = isset($_GET['tipo']) ? trim($_GET['tipo']) : '';
$filtroEstado = isset($_GET['estado']) ? trim($_GET['estado']) : '';

$where = [];
$params = [':eid'=>$eventoId];

$where[] = "evento_id = :eid";

if ($q !== '') {
    $where[] = "(nombre LIKE :q OR email LIKE :q OR codigo LIKE :q)";
    $params[':q'] = "%{$q}%";
}

if ($filtroTipo !== '') {
    $where[] = "tipo = :tipo";
    $params[':tipo'] = $filtroTipo;
}

if ($filtroEstado === 'checkin_ok') {
    $where[] = "checked_in = 1";
} elseif ($filtroEstado === 'pendiente') {
    $where[] = "checked_in = 0";
}

$whereSql = "WHERE " . implode(" AND ", $where);

// ========================
// Contadores del evento (SIN filtros)
// ========================
$stmtTotal = $pdo->prepare("SELECT COUNT(*) FROM entradas WHERE evento_id = :eid");
$stmtTotal->execute([':eid'=>$eventoId]);
$total = (int)$stmtTotal->fetchColumn();

$stmtCheck = $pdo->prepare("SELECT COUNT(*) FROM entradas WHERE evento_id = :eid AND checked_in = 1");
$stmtCheck->execute([':eid'=>$eventoId]);
$checkins = (int)$stmtCheck->fetchColumn();

$faltan = max(0, $total - $checkins);

// ========================
// Listado filtrado
// ========================
$sql = "SELECT * FROM entradas $whereSql ORDER BY id DESC";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

// tipos distintos del evento
$tiposStmt = $pdo->prepare("SELECT DISTINCT tipo FROM entradas WHERE evento_id = :eid ORDER BY tipo ASC");
$tiposStmt->execute([':eid'=>$eventoId]);
$tipos = $tiposStmt->fetchAll(PDO::FETCH_COLUMN);

?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title><?php echo e($evento['nombre']); ?> – Admin evento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050505;
      color: #f5f5f5;
      padding: 16px;
    }
    a{color:inherit}

    .topbar{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:14px;
    }
    .topbar .spacer{flex:1 1 auto;}
    .btn-link{
      display:inline-block;padding:6px 10px;border-radius:10px;background:#222;color:#eee;text-decoration:none;
      font-size:.85rem;white-space:nowrap;
    }
    .btn-link:hover{background:#2d2d2d;}
    .btn-primary{background:#d71d24;}
    .btn-primary:hover{filter:brightness(1.05);}
    .btn-danger{background:#b51c26;}
    .btn-danger:hover{background:#d0212d;}
    .btn-checkin{background:#1f7a31;}
    .btn-checkin:hover{filter:brightness(1.08);}

    h1{margin:0 0 6px;font-size:1.45rem;}
    .small{font-size:.85rem;color:#9ca3af;margin-bottom:6px;}

    .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;margin-bottom:10px;}
    .card{
      background:#141414;border-radius:12px;padding:10px 14px;box-shadow:0 8px 20px rgba(0,0,0,.4);
      min-width:170px;
    }
    .card .label{font-size:.8rem;color:#aaa;}
    .card .value{margin-top:3px;font-size:1.5rem;font-weight:700;}
    .badge-ok{
      display:inline-block;padding:2px 8px;border-radius:999px;background:#124221;color:#a6f3b7;font-size:.75rem;
    }
    .badge-pend{
      display:inline-block;padding:2px 8px;border-radius:999px;background:#402018;color:#ffb39a;font-size:.75rem;
    }

    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px;}
    .filters input,.filters select{
      padding:7px 9px;border-radius:8px;border:1px solid #333;background:#111;color:#f5f5f5;font-size:.9rem;
    }
    .filters input{min-width:220px;}
    .filters button{
      padding:7px 12px;border-radius:999px;border:none;background:#d71d24;color:#fff;font-weight:600;cursor:pointer;
      font-size:.85rem;
    }

    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.9rem;}
    th,td{border-bottom:1px solid #333;padding:8px;vertical-align:middle;}
    th{background:#181818;text-align:left;position:sticky;top:0;}
    tr:hover td{background:#111;}

    @media(max-width:800px){
      table{font-size:.78rem;}
      th,td{padding:5px 4px;}
    }
  </style>
</head>
<body>

<div class="topbar">
  <a class="btn-link" href="panel_admin.php">Panel general</a>
  <a class="btn-link" href="eventos.php">Eventos</a>
  <a class="btn-link" href="secundarios.php">Mi staff</a>
  <span class="spacer"></span>
  <a class="btn-link" href="mi_perfil.php">Mi perfil</a>
  <a class="btn-link" href="login.php?logout=1">Salir</a>
</div>

<h1><?php echo e($evento['nombre']); ?> – Panel de evento</h1>
<div class="small">Slug: <strong><?php echo e($evento['slug']); ?></strong></div>

<div class="stats">
  <div class="card">
    <div class="label">Entradas totales</div>
    <div class="value"><?php echo $total; ?></div>
  </div>
  <div class="card">
    <div class="label">Check-ins realizados</div>
    <div class="value"><?php echo $checkins; ?></div>
  </div>
  <div class="card">
    <div class="label">Faltan por escanear</div>
    <div class="value"><?php echo $faltan; ?></div>
  </div>
</div>

<form method="get" class="filters">
  <input type="hidden" name="id" value="<?php echo $eventoId; ?>">
  <input
    type="text"
    name="q"
    placeholder="Buscar por nombre, mail o código"
    value="<?php echo e($q); ?>"
  />
  <select name="tipo">
    <option value="">Todos los tipos</option>
    <?php foreach ($tipos as $t): ?>
      <option value="<?php echo e($t); ?>" <?php if ($t === $filtroTipo) echo 'selected'; ?>>
        <?php echo e($t); ?>
      </option>
    <?php endforeach; ?>
  </select>
  <select name="estado">
    <option value="">Todos los estados</option>
    <option value="checkin_ok" <?php if ($filtroEstado === 'checkin_ok') echo 'selected'; ?>>Sólo checkeados</option>
    <option value="pendiente" <?php if ($filtroEstado === 'pendiente') echo 'selected'; ?>>Sólo pendientes</option>
  </select>
  <button type="submit">Filtrar</button>
</form>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Nombre / Alias</th>
      <th>Email</th>
      <th>Fecha registro</th>
      <th>Tipo</th>
      <th>Código</th>
      <th>Estado</th>
      <th>Check-IN</th>
      <th>Atrás</th>
      <th>Ver entrada</th>
      <th>Email / texto</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody>
  <?php if (empty($rows)): ?>
    <tr><td colspan="12" style="color:#aaa;">No hay entradas con esos filtros.</td></tr>
  <?php else: ?>
  <?php foreach ($rows as $r): ?>
    <?php
      $estadoOk = (isset($r['checked_in']) && (int)$r['checked_in'] === 1);
      $codigo   = isset($r['codigo']) ? $r['codigo'] : '';
    ?>
    <tr>
      <td><?php echo (int)$r['id']; ?></td>
      <td><?php echo e($r['nombre']); ?></td>
      <td><?php echo e($r['email']); ?></td>
      <td><?php echo e($r['fecha_registro']); ?></td>
      <td><?php echo e($r['tipo']); ?></td>
      <td><?php echo e($codigo); ?></td>
      <td>
        <?php if ($estadoOk): ?>
          <span class="badge-ok">Check in OK</span>
        <?php else: ?>
          <span class="badge-pend">Pendiente</span>
        <?php endif; ?>
      </td>
      <td>
        <?php if (!$estadoOk && $codigo !== ''): ?>
          <a class="btn-link btn-checkin" href="checkin.php?c=<?php echo urlencode($codigo); ?>">
            Hacer check in
          </a>
        <?php elseif ($estadoOk): ?>
          <span style="font-size:0.75rem;color:#9f9;">Ya checkeada</span>
        <?php endif; ?>
      </td>
      <td>
        <?php if ($estadoOk): ?>
          <a
            class="btn-link"
            href="panel_evento.php?id=<?php echo $eventoId; ?>&undo=<?php echo (int)$r['id']; ?>"
            onclick="return confirm('¿Deshacer check-in de la entrada #<?php echo (int)$r['id']; ?>?');"
          >
            Atrás
          </a>
        <?php else: ?>
          <span style="font-size:0.75rem;color:#aaa;">—</span>
        <?php endif; ?>
      </td>
      <td>
        <?php if ($codigo !== ''): ?>
          <a class="btn-link" href="ticket.php?c=<?php echo urlencode($codigo); ?>" target="_blank">
            Ver entrada
          </a>
        <?php endif; ?>
      </td>
      <td>
        <?php if ($codigo !== ''): ?>
          <a class="btn-link" href="email_t ?>" target="_blank">
            Ver texto
          </a>
        <?php endif; ?>
      </td>
      <td>
        <a
          class="btn-link btn-danger"
          href="panel_evento.php?id=<?php echo $eventoId; ?>&delete=<?php echo (int)$r['id']; ?>"
          onclick="return confirm('¿Seguro que querés eliminar la entrada #<?php echo (int)$r['id']; ?>?');"
        >
          Eliminar
        </a>
      </td>
    </tr>
  <?php endforeach; ?>
  <?php endif; ?>
  </tbody>
</table>

</body>
</html>
