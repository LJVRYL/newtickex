<?php
require_once __DIR__.'/inc/bootstrap.php';
$title = "Configurar entradas del evento";

require_login();

$cu = current_user();
$tipoGlobal = isset($_SESSION['tipo_global']) ? $_SESSION['tipo_global'] : (isset($cu['rol'])?$cu['rol']:'');
if (!in_array($tipoGlobal, array('admin_evento','super_admin','superadmin'), true)) {
    header("Location: login.php");
    exit;
}

$adminId  = isset($_SESSION['user_id']) ? (int)$_SESSION['user_id'] : (isset($cu['id'])?(int)$cu['id']:0);
$eventoId = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($eventoId <= 0) {
    abort_404("ID de evento inv√°lido.");
}

try {
    $pdo = db();
} catch (Exception $e) {
    http_response_code(500);
    echo "Error DB: " . e($e->getMessage());
    exit;
}

// ===== Evento =====
$stEv = $pdo->prepare("SELECT * FROM eventos WHERE id = ?");
$stEv->execute(array($eventoId));
$evento = $stEv->fetch(PDO::FETCH_ASSOC);
if (!$evento) {
    abort_404("Evento no encontrado.");
}

// Detectar columnas opcionales en eventos
$colsEv = $pdo->query("PRAGMA table_info(eventos)")->fetchAll(PDO::FETCH_ASSOC);
$hasCreadoPor = false;
foreach($colsEv as $c){
    if (isset($c['name']) && $c['name']==='creado_por_admin_id') {
        $hasCreadoPor = true;
        break;
    }
}

// admin_evento solo puede tocar sus eventos
if ($tipoGlobal === 'admin_evento' && $hasCreadoPor) {
    $creador = isset($evento['creado_por_admin_id']) ? (int)$evento['creado_por_admin_id'] : 0;
    if ($creador !== $adminId) {
        abort_404("No pod√©s modificar este evento.");
    }
}

// Detectar si tipos_entrada tiene columna activo
$colsTE = $pdo->query("PRAGMA table_info(tipos_entrada)")->fetchAll(PDO::FETCH_ASSOC);
$hasActivoTipos = false;
foreach($colsTE as $c){
    if (isset($c['name']) && $c['name']==='activo') {
        $hasActivoTipos = true;
        break;
    }
}

$error = '';
$okMsg = '';

// =======================
// ELIMINAR TIPO DEL EVENTO (tachito)
// =======================
if (isset($_GET['del_te'])) {
    $teId = (int)$_GET['del_te'];

    $st = $pdo->prepare("SELECT id FROM tipos_entrada WHERE id=? AND evento_id=?");
    $st->execute(array($teId, $eventoId));
    if ($st->fetch()) {
        $pdo->prepare("DELETE FROM tipos_entrada WHERE id=?")->execute(array($teId));
        header("Location: configurar_entradas_evento.php?id=" . $eventoId);
        exit;
    } else {
        $error = "Tipo de entrada inexistente para este evento.";
    }
}

// =======================
// AGREGAR TIPO DESDE PLANTILLA (Mis Entradas)
// =======================
if ($_SERVER["REQUEST_METHOD"]==="POST" && isset($_POST["add_from_template"])) {

    $tplId = isset($_POST["tpl_id"]) ? (int)$_POST["tpl_id"] : 0;
    if ($tplId <= 0) {
        $error = "Plantilla inv√°lida.";
    }

    if (!$error) {
        // Respetamos filtro por admin (igual que en la lista)
        $sqlTpl = "
            SELECT * FROM plantillas_entrada
            WHERE id=? AND activo=1
        ";
        $paramsTpl = array($tplId);

        if ($tipoGlobal!=='super_admin' && $tipoGlobal!=='superadmin') {
            $sqlTpl .= " AND creado_por_admin_id=? ";
            $paramsTpl[] = $adminId;
        }

        $stTpl = $pdo->prepare($sqlTpl);
        $stTpl->execute($paramsTpl);
        $tpl = $stTpl->fetch(PDO::FETCH_ASSOC);
        if (!$tpl) {
            $error = "No se encontr√≥ la plantilla o no ten√©s permiso para usarla.";
        }
    }

    if (!$error) {
        $tipoVenta = strtoupper($tpl["tipo"]); // FREE / PAGA / ...
        $precio    = (int)$tpl["precio_default"];
        $cant      = (int)$tpl["cantidad_default"];
        $hora      = isset($tpl["hora_limite_default"]) ? $tpl["hora_limite_default"] : null;
        $desc      = isset($tpl["descripcion"]) ? $tpl["descripcion"] : null;

        if ($tipoVenta === "FREE") {
            $precio = 0;
        }

        $sqlIns = "
            INSERT INTO tipos_entrada
              (evento_id, categoria, nombre, tipo_venta, precio,
               cantidad_total, cantidad_disponible, hora_limite, descripcion
        ;
        if ($hasActivoTipos) {
            $sqlIns .= ", activo";
        }
        $sqlIns .= ")
            VALUES
              (:eid,:cat,:nom,:tv,:pre,:ct,:cd,:hl,:desc";
        if ($hasActivoTipos) {
            $sqlIns .= ", 1";
        }
        $sqlIns .= ")
        ";

        $stIns = $pdo->prepare($sqlIns);
        $stIns->execute(array(
            ":eid" => $eventoId,
            ":cat" => $tpl["categoria"],
            ":nom" => $tpl["nombre"],
            ":tv"  => $tipoVenta,
            ":pre" => $precio,
            ":ct"  => $cant,
            ":cd"  => $cant,
            ":hl"  => $hora,
            ":desc"=> $desc
        ));

        $okMsg = "Tipo de entrada agregado al evento desde Mis Entradas.";
    }
}

// =======================
// GUARDAR ESTADO ACTIVO/INACTIVO DE TIPOS (si existe columna activo)
// =======================
if ($_SERVER['REQUEST_METHOD']==='POST' && isset($_POST['save_estado_tipos']) && $hasActivoTipos) {
    // IDs marcados como activos
    $activosIds = array();
    if (isset($_POST['activo']) && is_array($_POST['activo'])) {
        foreach($_POST['activo'] as $id => $val) {
            $activosIds[] = (int)$id;
        }
    }

    // Obtener todos los tipos del evento
    $stAll = $pdo->prepare("SELECT id FROM tipos_entrada WHERE evento_id=?");
    $stAll->execute(array($eventoId));
    $todos = $stAll->fetchAll(PDO::FETCH_COLUMN);

    $stUpd = $pdo->prepare("UPDATE tipos_entrada SET activo=:a WHERE id=:id AND evento_id=:eid");

    foreach($todos as $id) {
        $id = (int)$id;
        $esActivo = in_array($id, $activosIds, true) ? 1 : 0;
        $stUpd->execute(array(
            ':a'   => $esActivo,
            ':id'  => $id,
            ':eid' => $eventoId
        ));
    }

    $okMsg = 'Estados de tipos de entrada actualizados.';
}

// ===== Tipos ya asociados al evento =====
$stTE = $pdo->prepare("SELECT * FROM tipos_entrada WHERE evento_id=? ORDER BY categoria ASC, nombre ASC, id ASC");
$stTE->execute(array($eventoId));
$tiposEvento = $stTE->fetchAll(PDO::FETCH_ASSOC);

// ===== Plantillas (Mis Entradas) del admin =====
$params = array();
$sqlTpl = "SELECT * FROM plantillas_entrada WHERE activo=1 ";
if ($tipoGlobal!=='super_admin' && $tipoGlobal!=='superadmin') {
    $sqlTpl .= "AND creado_por_admin_id=? ";
    $params[] = $adminId;
}
$sqlTpl .= "ORDER BY categoria ASC, nombre ASC";
$stTpl = $pdo->prepare($sqlTpl);
$stTpl->execute($params);
$plantillas = $stTpl->fetchAll(PDO::FETCH_ASSOC);

include __DIR__.'/inc/layout_top.php';
?>

<div class="card" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
  <a class="btn secondary" href="plver al panel</a>
  <a class="btn secondary" href="editar_evento.php?id=<?php echo (int)$eventoId; ?>">‚úè Editar datos del evento</a>
  <a class="btn secondary" href="plantillas_entrada.php">‚öô Mis entradas (plantillas)</a>
  <span style="flex:1 1 auto;"></span>
</div>

<?php if($error): ?>
  <div class="flash err"><?php echo e($error); ?></div>
<?php endif; ?>
<?php if($okMsg): ?>
  <div class="flash ok"><?php echo e($okMsg); ?></div>
<?php endif; ?>

<div class="card">
  <h2>Configurar entradas para: <?php echo e($evento['nombre']); ?></h2>
  <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;align-items:flex-start;">
    <div style="flex:1 1 220px;">
      <div class="muted">Slug / URL</div>
      <div><code><?php echo e($evento['slug']); ?></code></div>

      <div class="muted" style="margin-top:8px;">Fechas</div>
      <div>
        <?php
          $fd = isset($evento['fecha_desde']) ? $evento['fecha_desde'] : '';
          $fh = isset($evento['fecha_hasta']) ? $evento['fecha_hasta'] : '';
          if ($fd==='' && $fh==='') {
              echo '<span class="muted">Sin fecha definida</span>';
          } else {
              echo e($fd);
              if ($fh!=='') echo ' ‚Üí '.e($fh);
          }
        ?>
      </div>

      <div class="muted" style="margin-top:8px;">Descripci√≥n</div>
      <div><?php echo nl2br(e(isset($evento['descripcion'])?$evento['descripcion']:'')); ?></div>
    </div>

    <div>
      <div class="muted">Flyer</div>
      <?php
        $flyerOk = (!empty($evento['flyer_filename']) && file_exists(__DIR__ . '/' . $evento['flyer_filename']));
      ?>
      <?php if($flyerOk): ?>
        <img src="<?php echo e($evento['flyer_filename']); ?>" alt="Flyer"
             style="width:160px;height:160px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#000;">
      <?php else: ?>
        <div class="muted">Sin flyer.</div>
      <?php endif; ?>
    </div>
  </div>
</div>

<div class="card">
  <h3>Agregar tipos desde Mis Entradas</h3>
  <?php if(empty($plantillas)): ?>
    <div class="muted">No ten√©s plantillas activas. Crealas en <a href="plantillas_entrada.php">Mis Entradas</a>.</div>
  <?php else: ?>
    <form method="post" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <label for="tpl_id" class="muted">Plantilla:</label>
      <select name="tpl_id" id="tpl_id">
        <?php foreach($plantillas as $tpl): ?>
          <option value="<?php echo (int)$tpl['id']; ?>">
            <?php echo e($tpl['categoria']); ?> ‚Äì <?php echo e($tpl['nombre']); ?>
            (<?php echo e($tpl['tipo']); ?>,
             $<?php echo (int)$tpl['precio_default']; ?>,
             <?php echo (int)$tpl['cantidad_default']; ?>)
          </option>
        <?php endforeach; ?>
      </select>
      <button class="btn" type="submit" name="add_from_template" value="1">Agregar al evento</button>
    </form>
  <?php endif; ?>
</div>

<div class="card">
  <h3>Tipos de entrada del evento</h3>

  <?php if(empty($tiposEvento)): ?>
    <div class="muted">Este evento todav
√  <?php else: ?>
    <form method="post">
      <table class="table" style="margin-top:8px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Categor√≠a</th>
            <th>Nombre</th>
            <th>Tipo venta</th>
            <th>Precio</th>
            <th>Total</th>
            <th>Disponible</th>
            <th>Hora l√≠mite</th>
            <?php if($hasActivoTipos): ?>
              <th>Activo</th>
            <?php endif; ?>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach($tiposEvento as $te): ?>
            <tr>
              <td><?php echo (int)$te['id']; ?></td>
              <td><?php echo e($te['categoria']); ?></td>
              <td><?php echo e($te['nombre']); ?></td>
              <td><?php echo e($te['tipo_venta']); ?></td>
              <td>$<?php echo (int)$te['precio']; ?></t
              <td><?php echo (int)$te['cantidad_total']; ?></td>
              <td><?php echo (int)$te['cantidad_disponible']; ?></td>
              <td><?php echo e($te['hora_limite']); ?></td>
              <?php if($hasActivoTipos): ?>
                <td style="text-align:center;">
                  <?php
                    $valorActivo = isset($te['activo']) ? (int)$te['activo'] : 1;
                  ?>
                  <input type="checkbox"
                         name="activo[<?php echo (int)$te['id']; ?>]"
                         value="1"
                         <?php echo $valorActivo ? 'checked' : ''; ?>>
                </td>
              <?php endif; ?>
              <td>
                <a class="btn secondary"
                   href="configurar_entradas_evento.php?id=<?php echo (int)$eventoId; ?>&del_te=<?php echo (int)$te['id']; ?>"
                   onclick="return confirm('¬øEliminar este tipo de entrada del evento?');">
                  üóë
                </a>
              </td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>

      <?php if($hasActivoTipos && !empty($tiposEvento)): ?>
        <div style="margin-top:8px;">
          <button class="btn" type="submit" name="save_estad
        </div>
      <?php endif; ?>
    </form>
  <?php endif; ?>
</div>

<div class="card" style="display:flex;gap:8px;flex-wrap:wrap;">
  <a class="btn" href="publicar_evento.php?id=<?php echo (int)$eventoId; ?>">‚úÖ Publicar evento</a>
</div>

<?php include __DIR__.'/inc/layout_bottom.php'; ?>
