<?php
session_start();

// Solo usuarios con rol 'puerta' o 'admin'
if (!isset($_SESSION['rol']) || !in_array($_SESSION['rol'], ['puerta', 'admin'])) {
    header('Location: admin.php');
    exit;
}

// Conexión
$dbFile = __DIR__ . '/save_the_rave.sqlite';
$pdo = new PDO('sqlite:' . $dbFile);
$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

// ===== Filtros =====
$q            = isset($_GET['q'])      ? trim($_GET['q'])      : '';
$filtroTipo   = isset($_GET['tipo'])   ? trim($_GET['tipo'])   : '';
$filtroEstado = isset($_GET['estado']) ? trim($_GET['estado']) : '';

$where  = [];
$params = [];

// búsqueda por nombre / email / código
if ($q !== '') {
    $where[]      = '(nombre LIKE :q OR email LIKE :q OR codigo LIKE :q)';
    $params[':q'] = '%' . $q . '%';
}

// filtro por tipo
if ($filtroTipo !== '') {
    $where[]         = 'tipo = :tipo';
    $params[':tipo'] = $filtroTipo;
}

// filtro por estado
if ($filtroEstado === 'checkin_ok') {
    $where[] = 'checked_in = 1';
} elseif ($filtroEstado === 'pendiente') {
    $where[] = 'checked_in = 0';
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// ===== Contadores (con mismos filtros) =====

// total dentro del subconjunto filtrado
$sqlTotal  = "SELECT COUNT(*) FROM entradas $whereSql";
$stmtTotal = $pdo->prepare($sqlTotal);
$stmtTotal->execute($params);
$total = (int)$stmtTotal->fetchColumn();

// check-ins dentro del subconjunto filtrado
if ($whereSql === '') {
    $sqlCheckins = "SELECT COUNT(*) FROM entradas WHERE checked_in = 1";
    $stmtCheck   = $pdo->prepare($sqlCheckins);
    $stmtCheck->execute();
} else {
    $sqlCheckins = "SELECT COUNT(*) FROM entradas $whereSql AND checked_in = 1";
    $stmtCheck   = $pdo->prepare($sqlCheckins);
    $stmtCheck->execute($params);
}
$checkins = (int)$stmtCheck->fetchColumn();

// faltan = total - checkins
$faltan = max(0, $total - $checkins);

// ===== Listado de entradas filtradas =====
$sqlRows = "SELECT id, nombre, email, tipo, checked_in, codigo 
            FROM entradas
            $whereSql
            ORDER BY id DESC";
$stmtRows = $pdo->prepare($sqlRows);
$stmtRows->execute($params);
$rows = $stmtRows->fetchAll(PDO::FETCH_ASSOC);

// tipos para combo
$tiposStmt = $pdo->query("SELECT DISTINCT tipo FROM entradas ORDER BY tipo ASC");
$tipos = $tiposStmt->fetchAll(PDO::FETCH_COLUMN);

?>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Puerta – Save The Rave</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:#050505;
  color:#f5f5f5;
  padding:16px;
  margin:0;
}
h1 { font-size:1.3rem; margin:0 0 4px; }
.small { font-size:0.8rem; color:#aaa; }

.top {
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:12px;
}

.stats { display:flex; gap:10px; flex-wrap:wrap; }
.card {
  background:#141414;
  border-radius:12px;
  padding:8px 12px;
  min-width:120px;
  box-shadow:0 8px 20px rgba(0,0,0,0.5);
}
.card .label { font-size:0.75rem; color:#a1a1aa; }
.card .value { font-size:1.3rem; font-weight:700; }

.filters {
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}
.filters input,
.filters select {
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #333;
  background:#111;
  color:#e5e5e5;
  font-size:0.8rem;
}
.filters button {
  padding:6px 10px;
  border-radius:999px;
  border:none;
  background:#d71d24;
  color:#fff;
  font-size:0.8rem;
  font-weight:600;
  cursor:pointer;
}
.filters button:hover { filter:brightness(1.05); }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:0.8rem;
}
th, td {
  padding:6px 8px;
  border-bottom:1px solid #262626;
}
th {
  background:#181818;
  position:sticky;
  top:0;
  z-index:1;
  text-align:left;
}
tr:hover td { background:#101010; }

.btn-link {
  display:inline-block;
  padding:3px 8px;
  border-radius:8px;
  backgroun
  color:#eee;
  text-decoration:none;
  font-size:0.78rem;
  white-space:nowrap;
}
.btn-link:hover { background:#2d2d2d; }

.btn-checkin {
  background:#16a34a;
  color:#fff;
}
.btn-checkin:hover { filter:brightness(1.08); }

.badge-ok {
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  background:#124221;
  color:#a6f3b7;
  font-size:0.75rem;
}
.badge-pend {
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  background:#402018;
  color:
  font-size:0.75rem;
}

.logout {
  position:fixed;
  top:10px;
  right:10px;
  background:#18181b;
  padding:6px 10px;
  border-radius:999px;
  text-decoration:none;
  color:#e5e5e5;
  font-size:0.75rem;
}
.logout:hover { background:#27272a; }

@media(max-width:800px){
  table{font-size:0.75rem;}
  th,td{padding:4px 5px;}
}
</style>
</head>
<body>

<a href="admin.php?logout=1" class="logout">Salir</a>

<div class="top">
  <div>
    <h1>Check-in – Modo Puerta</h1>
    <div class="small">
      Usuario: <strong><?php echo htmlspecialchars($_SESSION['usuario']); ?></strong>
    </div>
  </div>

  <div class="stats">
    <div class="card">
      <div class="label">Entradas (con filtros)</div>
      <div class="value"><?php echo (int)$total; ?></div>
    </div>
    <div class="card">
      <div class="label">Check-ins</div>
      <div class="value"><?php echo (int)$checkins; ?></div>
    </div>
    <div class="card">
      <div class="label">Faltan</div>
      <div class="value"><?php echo (int)$faltan; ?></div>
    </div>
  </div>
</div>

<form method="get" class="filters">
  <input
    type="text"
    name="q"
    placeholder="Buscar por nombre, mail o código"
    value="<?php echo htmlspecialchars($q); ?>"
  />
  <select name="tipo">
    <option value="">Todos los tipos</option>
    <?php foreach ($tipos as $t): ?>
      <option value="<?php echo htmlspecialchars($t); ?>" <?php if ($t === $filtroTipo) echo 'selected'; ?>>
        <?php echo htmlspecialchars($t); ?>
      </option>
    <?php endforeach; ?>
  </select>
  <select name="estado">
    <option value="">Todos los estados</option>
    <option value="checkin_ok" <?php if ($filtroEstado === 'checkin_ok') echo 'selected'; ?>>Sólo checkeados</option>
    <option value="pendiente" <?php if ($filtroEstado === 'pendiente') echo 'selected'; ?>>Sólo pendientes</option>
  </select>
  <button type="submit">Filtrar</button>
</form>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Nombre</th>
  <th>Tipo</th>
  <th>Estado</th>
  <th>Check-IN</th>
  <th>Ver entrada</th>
  <th>Email / texto</th>
</tr>
</thead>
<tbody>

<?php foreach ($rows as $r): ?>
<tr>
  <td><?php echo (int)$r['id']; ?></td>
  <td><?php echo htmlspecialchars($r['nombre']); ?></td>
  <td><?php echo htmlspecialchars($r['tipo']); ?></td>
  <td>
    <?php if ((int)$r['checked_in'] === 1): ?>
      <span class="badge-ok">Check in OK</span>
    <?php else: ?>
      <span class="badge-pend">Pendiente</span>
    <?php endif; ?>
  </td>

  <td>
    <?php if (!(int)$r['checked_in'] && !empty($r['codigo'])): ?>
      <a class="btn-link btn-checkin" href="checkin.php?c=<?php echo urlencode($r['codigo']); ?>">
        Hacer check in
      </a>
    <?php elseif ((int)$r['checked_in'] === 1): ?>
      <span style="font-size:0.75rem;color:#9f9;">Ya checkeada</span>
    <?php endif; ?>
  </td>

  <td>
    <?php if (!empty($r['codigo'])): ?>
      <a class="btn-link" href="ticket.php?c=<?php echo urlencode($r['codigo']); ?>" target="_blank">
        Ver entrada
      </a>
    <?php endif; ?>
  </td>

  <td>
    <?php if (!empty($r['codigo'])): ?>
      <a class="btn-link" href="email_template.php?c=<?php echo urlencode($r['codigo']); ?>" target="_blank">
        Ver texto
      </a>
    <?php endif; ?>
  </td>
</tr>
<?php endforeach; ?>

</tbody>
</table>

</body>
</html>
