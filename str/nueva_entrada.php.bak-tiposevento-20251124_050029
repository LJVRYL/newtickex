<?php
// nueva_entrada.php (PHP5 safe)
// Alta manual desde Puerta usando tipos_entrada por evento.

session_start();
date_default_timezone_set('America/Argentina/Buenos_Aires');

function e($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }

// ===== AUTH: solo puerta =====
if (empty($_SESSION['usuario'])) { header("Location: login.php"); exit; }

$tipoGlobal = isset($_SESSION['tipo_global']) ? $_SESSION['tipo_global'] : '';
$rolEvento  = isset($_SESSION['rol_evento']) ? $_SESSION['rol_evento'] : '';

if (!($tipoGlobal==='staff_evento' && $rolEvento==='puerta')) {
    header("Location: login.php"); exit;
}

// ===== EVENTO actual =====
$eventoId = 0;
if (isset($_GET['evento_id']))      $eventoId = (int)$_GET['evento_id'];
else if (isset($_SESSION['evento_id'])) $eventoId = (int)$_SESSION['evento_id'];

if ($eventoId <= 0) { echo "Evento inválido."; exit; }

// ===== DB =====
$dbFile = __DIR__ . '/save_the_rave.sqlite';
if (!file_exists($dbFile)) die("Base de datos no encontrada.");

try {
    $pdo = new PDO('sqlite:' . $dbFile);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (Exception $ex) {
    die("Error DB: ".e($ex->getMessage()));
}

// ===== Evento info =====
$eventoNombre = '';
$eventoSlug   = '';
$stmtEv = $pdo->prepare("SELECT nombre, slug FROM eventos WHERE id=? LIMIT 1");
$stmtEv->execute(array($eventoId));
$evInfo = $stmtEv->fetch(PDO::FETCH_ASSOC);
if ($evInfo) {
    $eventoNombre = $evInfo['nombre'];
    $eventoSlug   = $evInfo['slug'];
}

// ===== Tipos del evento =====
$stmtTipos = $pdo->prepare("
    SELECT id, nombre, tipo, precio, cantidad_total, cantidad_disponible, hora_limite
    FROM tipos_entrada
    WHERE evento_id=?
    ORDER BY id ASC
");
$stmtTipos->execute(array($eventoId));
$tiposEvento = $stmtTipos->fetchAll(PDO::FETCH_ASSOC);

// ===== Estado del form =====
$errores = array();
$ok = false;

$nombre = '';
$tipoIdSel = 0;
$pagoRaw = '';

if ($_SERVER['REQUEST_METHOD']==='POST') {

    $nombre    = isset($_POST['nombre']) ? trim($_POST['nombre']) : '';
    $tipoIdSel = isset($_POST['tipo_id']) ? (int)$_POST['tipo_id'] : 0;
    $pagoRaw   = isset($_POST['pago']) ? trim($_POST['pago']) : '';

    if ($nombre==='')  $errores[]="El nombre es obligatorio.";
    if ($tipoIdSel<=0) $errores[]="Elegí un tipo de entrada.";

    // buscar tipo elegido
    $tipoElegido = null;
    foreach($tiposEvento as $te){
        if ((int)$te['id']===$tipoIdSel) { $tipoElegido=$te; break; }
    }
    if (!$tipoElegido) $errores[]="Tipo inválido para este evento.";

    // normalizar pago
    $monto = 0;
    if ($pagoRaw!=='') {
        $tmp = str_replace(',', '.', $pagoRaw);
        if (!is_numeric($tmp)) $errores[]="El monto debe ser numérico.";
        else $monto = (int)round((float)$tmp);
    }

    if (empty($errores)) {

        $tipoNombre = $tipoElegido['nombre'];
        $tipoModo   = $tipoElegido['tipo']; // free/paga
        $precioDef  = (int)$tipoElegido['precio'];

        if ($tipoModo==='free') { $precioDef=0; $monto=0; }
        if ($tipoModo==='paga' && $monto<=0) $monto=$precioDef;

        $fecha = date('Y-m-d H:i:s');

        // código único
        $codigo = '';
        $maxIntentos = 5;
        for($i=0; $i<$maxIntentos; $i++){
            if (function_exists('random_bytes')) $codigo = bin2hex(random_bytes(5));
            else $codigo = substr(sha1(uniqid('', true)), 0, 10);

            try {
                $stmtIns = $pdo->prepare("
                    INSERT INTO entradas
                      (evento_id, nombre, email, fecha_registro, codigo, checked_in, checked_in_at, tipo, monto_pagado)
                    VALUES
                      (:eid, :nombre, '', :fecha, :codigo, 0, NULL, :tipo, :monto)
                ");
                $stmtIns->execute(array(
                    ':eid'    => $eventoId,
                    ':nombre' => $nombre,
                    ':fecha'  => $fecha,
                   
                    ':tipo'   => $tipoNombre,
    
                ));
                $ok = true;
      
            } catch (Exception $ex) {
                if (stripos($ex->getMessage(),'UNIQUE')!==false) continue;
                $errores[]="Error al guardar: ".$ex->getMessage();
                break;
            }
        }

        if ($ok) {
            // bajar disponibles si aplica
            if ((int)$tipoElegido['cantidad_total']>0) {
                $stmtUpd = $pdo->prepare("
                    UPDATE tipos_entrada
                    SET cantidad_disponible = CASE
                        WHEN cantidad_disponible>0 THEN cantidad_disponible-1
                        ELSE 0
                    END
                    WHERE id=?
                ");
                $stmtUpd->execute(array($tipoIdSel));
            }

            // limpiar
            $nombre=''; $pagoRaw=''; $tipoIdSel=0;

            // recargar lista
            $stmtTipos->execute(array($eventoId));
            $tiposEvento = $stmtTipos->fetchAll(PDO::FETCH_ASSOC);
        }
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Nueva entrada – Puerta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/str.css">
  <style>
    body{padding:16px;}
    .card{max-width:520px;margin:0 auto;}
    .back-link{display:inline-block;margin-bottom:10px;}
    .help{font-size:12px;color:var(--muted);margin-top:4px;}
    .btn-submit{width:100%;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <a class="link back-link" href="puerta.php?evento_id=<?php echo (int)$eventoId; ?>">← Volver a puerta</a>

    <h2>Nueva entrada (puerta)</h2>

    <?php if($eventoNombre!==''): ?>
      <div class="muted" style="margin-bottom:8px;">
        Evento: <strong><?php echo e($eventoNombre); ?></strong>
        <?php if($eventoSlug!=='') echo " (".e($eventoSlug).")"; ?>
      </div>
    <?php endif; ?>

    <?php if($ok): ?>
      <div class="flash ok">✅ Entrada guardada correctamente.</div>
    <?php endif; ?>

    <?php if(!empty($errores)): ?>
      <div class="flash err">
        <?php foreach($errores as $er): ?>
          <div>• <?php echo e($er); ?></div>
        <?php endforeach; ?>
      </div>
    <?php endif; ?>

    <?php if(empty($tiposEvento)): ?>
      <div class="flash warn" style="margin-top:10px;">
        Sin tipos de entrada.<br>
        Este evento no tiene tipos definidos.
      </div>
    <?php else: ?>
      <form method="post" style="margin-top:10px;">
        <label>Nombre / alias</label>
        <input type="text" name="nombre" required value="<?php echo e($nombre); ?>">

        <label>Tipo de entrada</label>
        <select name="tipo_id" required>
          <option value="">Elegí un tipo...</option>
          <?php foreach($tiposEvento as $te): ?>
            <?php
              $id  = (int)$te['id'];
              $nm  = $te['nombre'];
              $md  = $te['tipo'];
              $pr  = (int)$te['precio'];
              $cd  = (int)$te['cantidad_disponible'];
              $ct  = (int)$te['cantidad_total'];

              $label = $nm;
              if ($md==='free') $label .= " — FREE";
              else $label .= " — $".$pr;
              if ($ct>0) $label .= " (disp: ".$cd.")";
            ?>
            <option value="<?php echo $id; ?>" <?php if($id===$tipoIdSel) echo 'selected'; ?>>
              <?php echo e($label); ?>
            </option>
          <?php endforeach; ?>
        </select>

        <label>Pago (en pesos)</label>
        <input type="text" name="pago" placeholder="Ej: 0, 10000, 15000..." value="<?php echo e($pagoRaw); ?>">
        <div class="help">Si el tipo es FREE, se fuerza a $0.</div>

        <div style="margin-top:10px;">
          <button class="btn btn-submit" type="submit">Guardar entrada</button>
        </div>
      </form>
    <?php endif; ?>

  </div>
</div>
</body>
</html>
