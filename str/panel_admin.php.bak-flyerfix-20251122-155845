<?php
session_start();
date_default_timezone_set('America/Argentina/Buenos_Aires');

function e($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }

// ===== AUTH =====
if (empty($_SESSION['usuario'])) {
    header("Location: login.php");
    exit;
}

$tipoGlobal = isset($_SESSION['tipo_global']) ? $_SESSION['tipo_global'] : '';
if (!($tipoGlobal === 'admin_evento' || $tipoGlobal === 'super_admin')) {
    header("Location: login.php");
    exit;
}

$adminId = isset($_SESSION['user_id']) ? (int)$_SESSION['user_id'] : 0;
if ($adminId <= 0 && $tipoGlobal !== 'super_admin') {
    echo "Sesión inválida.";
    exit;
}

// ===== DB =====
$dbFile = __DIR__ . '/save_the_rave.sqlite';
try {
    $pdo = new PDO('sqlite:' . $dbFile);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (Throwable $ex) {
    http_response_code(500);
    echo "Error DB: " . e($ex->getMessage());
    exit;
}

// ===== Filtros eventos =====
$qev = '';
if (isset($_GET['qev'])) {
    $qev = trim($_GET['qev']);
}

$fev = '';
if (isset($_GET['fev'])) {
    $fev = trim($_GET['fev']);
}
// fev: '' todos | 'pendientes' | 'ok'

// ===== Traer eventos del admin actual =====
$where = array();
$params = array();

if ($tipoGlobal !== 'super_admin') {
    $where[] = "ev.creado_por_admin_id = :aid";
    $params[':aid'] = $adminId;
}

if ($qev !== '') {
    $where[] = "(ev.nombre LIKE :q OR ev.slug LIKE :q)";
    $params[':q'] = '%' . $qev . '%';
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = "WHERE " . implode(" AND ", $where);
}

// Traemos eventos
$stmtEv = $pdo->prepare("
    SELECT ev.*
    FROM eventos ev
    $whereSql
    ORDER BY ev.id DESC
");
$stmtEv->execute($params);
$eventos = $stmtEv->fetchAll(PDO::FETCH_ASSOC);

// ===== Stats por evento (totales/checkins/pendientes) =====
$ids = array();
foreach ($eventos as $ev) { $ids[] = (int)$ev['id']; }

$statsPorEvento = array();
if (!empty($ids)) {
    $in = implode(',', $ids);
    $sqlStats = "
        SELECT evento_id,
               COUNT(*) AS total,
               SUM(CASE WHEN checked_in=1 THEN 1 ELSE 0 END) AS checkins
        FROM entradas
        WHERE evento_id IN ($in)
        GROUP BY evento_id
    ";
    $rowsStats = $pdo->query($sqlStats)->fetchAll(PDO::FETCH_ASSOC);
    foreach ($rowsStats as $st) {
        $eid = (int)$st['evento_id'];
        $tot = (int)$st['total'];
        $chk = (int)$st['checkins'];
        $statsPorEvento[$eid] = array(
            'total' => $tot,
            'checkins' => $chk,
            'pendientes' => max(0, $tot - $chk),
        );
    }
}

// ===== Aplicar filtro fev (pendientes / ok) =====
if ($fev !== '') {
    $filtrados = array();
    foreach ($eventos as $ev) {
        $eid = (int)$ev['id'];
        $st = isset($statsPorEvento[$eid]) ? $statsPorEvento[$eid] : array('total'=>0,'checkins'=>0,'pendientes'=>0);

        if ($fev === 'pendientes' && $st['pendientes'] > 0) {
            $filtrados[] = $ev;
        } elseif ($fev === 'ok' && $st['total'] > 0 && $st['pendientes'] == 0) {
            $filtrados[] = $ev;
        } elseif ($fev === '') {
            $filtrados[] = $ev;
        } elseif ($fev !== 'pendientes' && $fev !== 'ok') {
            $filtrados[] = $ev;
        }
    }
    $eventos = $filtrados;
}

// ===== Contadores globales (todos los eventos del admin) =====
if ($tipoGlobal === 'super_admin') {
    $totalEntradas   = (int)$pdo->query("SELECT COUNT(*) FROM entradas")->fetchColumn();
    $totalCheckins   = (int)$pdo->query("SELECT COUNT(*) FROM entradas WHERE checked_in=1")->fetchColumn();
    $totalEventos    = (int)$pdo->query("SELECT COUNT(*) FROM eventos")->fetchColumn();
} else {
    $totalEventos = (int)$pdo->prepare("SELECT COUNT(*) FROM eventos WHERE creado_por_admin_id=:aid")
                             ->execute(array(':aid'=>$adminId))
                             ? (int)$pdo->query("SELECT COUNT(*) FROM eventos WHERE creado_por_admin_id=".$adminId)->fetchColumn()
                             : 0;

    $stmtGlobal = $pdo->prepare("
        SELECT COUNT(*) AS
               SUM(CASE WHEN checked_in=1 THEN 1 ELSE 0 END) AS checkins
        FROM entradas
        WHERE evento_id IN (SELECT id FROM eventos WHERE creado_por_admin_id=:aid)
    ");
    $stmtGlobal->execute(array(':aid'=>$adminId));
    $g = $stmtGlobal->fetch(PDO::FETCH_ASSOC);
    $totalEntradas = isset($g['total']) ? (int)$g['total'] : 0;
    $totalCheckins = isset($g['checkins']) ? (int)$g['checkins'] : 0;
}
$totalPendientes = max(0, $totalEntradas - $totalCheckins);

?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel general – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{color-scheme:dark;}
    body{
      margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#050505;color:#f5f5f5;padding:16px;
    }
    h1{margin:0 0 6px;font-size:1.45rem;}
    .small{font-size:.85rem;color:#9ca3af;}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .top-left,.top-center,.top-right{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .btn-link{
      display:inline-block;padding:7px 12px;border-radius:10px;background:#222;color:#eee;text-decoration:none;
      font-size:.9rem;white-space:nowrap;
    }
    .btn-link:hover{background:#2d2d2d;}
    .btn-primary{background:#d71d24;}
    .btn-primary:hover{filter:brightness(1.08);}

    .stats{
      display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;
    }
    .card{
      background:#141414;border-radius:12px;padding:10px 14px;box-shadow:0 8px 20px rgba(0,0,0,.4);
      min-width:160px;flex:1 1 160px;
    }
    .card .label{font-size:.8rem;color:#aaa;}
    .card .value{margin-top:4px;font-size:1.5rem;font-weight:800;}

    .filters{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px;
    }
    .filters input,.filters select{
      padding:7px 9px;border-radius:8px;border:1px solid #333;background:#111;color:#f5f5f5;font-size:.9rem;
    }
    .filters button{
      padding:7px 14px;border-radius:999px;border:none;background:#d71d24;color:#fff;font-weight:700;cursor:pointer;
    }

    .section-title{
      margin-top:6px;margin-bottom:8px;font-size:1.1rem;font-weight:700;
    }

    table{width:100%;border-collapse:collapse;font-size:.9rem;}
    th,td{border-bottom:1px solid #333;padding:8px;vertical-align:middle;}
    th{background:#181818;text-align:left;position:sticky;top:0;z-index:1;}
    tr:hover td{background:#111;}

    .flyer-thumb{
      width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid #333;
    }
    .badge-ok{
      display:inline-block;padding:2px 8px;border-radius:999px;background:#124221;color:#a6f3b7;font-size:.75rem;
    }
    .badge-pend{
      display:inline-block;padding:2px 8px;border-radius:999px;background:#402018;color:#ffb39a;font-size:.75rem;
    }
    .muted{color:#9ca3af;font-size:.8rem;}
  </style>
</head>
<body>

<div class="topbar">
  <div class="top-left">
    <a class="btn-link btn-primary" href="crear_evento.php">Crear evento</a>
  </div>

  <div class="top-center">
    <a class="btn-link" href="secundarios.php">Mi staff</a>
    <a class="btn-link" href="eventos.php">Ver todos los eventos</a>
    <a class="btn-link" href="mi_sitio.php">Mi sitio</a>
  </div>

  <div class="top-right">
    <a class="btn-link" href="mi_perfil.php">Mi perfil</a>
    <a class="btn-link" href="login.php?logout=1">Salir</a>
  </div>
</div>

<h1>Panel general del administrador</h1>
<div class="small">Usuario: <strong><?php echo e($_SESSION['usuario']); ?></strong></div>

<div class="stats">
  <div class="card">
    <div class="label">Entradas totales (todos mis eventos)</div>
    <div class="value"><?php echo (int)$totalEntradas; ?></div>
  </div>
  <div class="card">
    <div class="label">Check-ins realizados</div>
    <div class="value"><?php echo (int)$totalCheckins; ?></div>
  </div>
  <div class="card">
    <div class="label">Pendientes</div>
    <div class="value"><?php echo (int)$totalPendientes; ?></div>
  </div>
  <div class="card">
    <div class="label">Eventos creados</div>
    <div class="value"><?php echo (int)$totalEventos; ?></div>
  </div>
</div>

<form method="get" class="filters">
  <input type="text" name="qev" placeholder="Buscar evento por nombre o slug"
         value="<?php echo e($qev); ?>" />
  <select name="fev">
    <option value="" <?php if($fev==='') echo 'selected'; ?>>Todos los eventos</option>
    <option value="pendientes" <?php if($fev==='pendientes') echo 'selected'; ?>>Con pendientes</option>
    <option value="ok" <?php if($fev==='ok') echo 'selected'; ?>>Todo check-in OK</option>
  </select>
  <button type="submit">Filtrar</button>
</form>

<div class="section-title">Mis eventos</div>

<table>
  <thead>
    <tr>
      <th>Flyer</th>
      <th>Evento</th>
      <th>Slug</th>
      <th>Fecha</th>
      <th>Totales</th>
      <th>Check-ins</th>
      <th>Pendientes</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  <?php if (empty($eventos)): ?>
    <tr><td colspan="8" class="muted">No hay eventos para mostrar.</td></tr>
  <?php else: ?>
    <?php foreach($eventos as $ev): ?>
      <?php
        $eid = (int)$ev['id'];
        $st = isset($statsPorEvento[$eid]) ? $statsPorEvento[$eid] : array('total'=>0,'checkins'=>0,'pendientes'=>0);
        $fd = isset($ev['fecha_desde']) ? $ev['fecha_desde'] : '';
        $fh = isset($ev['fecha_hasta']) ? $ev['fecha_hasta'] : '';
      ?>
      <tr>
        <td>
          <?php if (!empty($ev['flyer_filename']) && file_exists(
            <img src="<?php echo e($ev['flyer_filename']); ?>" class="flyer-thumb" alt="Flyer">
          <?php else: ?>
            <span class="muted">Sin flyer</span>
          <?php endif; ?>
        </td>
        <td><?php echo e($ev['nombre']); ?></td>
        <td><?php echo e($ev['slug']); ?></td>
        <td>
          <?php
            if ($fd==='' && $fh==='') echo '<span class="muted">Sin fecha</span>';
            else {
              echo e($fd);
              if ($fh!=='') echo ' → ' . e($fh);
            }
          ?>
        </td>
        <td><?php echo (int)$st['total']; ?></td>
        <td><?php echo (int)$st['checkins']; ?></td>
        <td>
          <?php if ((int)$st['pendientes'] > 0): ?>
            <span class="badge-pend"><?php echo (int)$st['pendientes']; ?> pendientes</span>
          <?php else: ?>
            <span class="badge-ok">OK</span>
          <?php endif; ?>
        </td>
        <td>
          <a class="btn-link" href="panel_evento.php?id=<?php echo $eid; ?>">Administrar</a>
          <a class="btn-link" href="editar_evento.php?id=<?php echo $eid; ?>">Editar</a>
        </td>
      </tr>
    <?php endforeach; ?>
  <?php endif; ?>
  </tbody>
</table>

</body>
</html>
