<?php
// registro_usuario.php – Registro de usuarios Tickex (clientes)
// Compatible con PHP viejito (sin random_bytes ni password_hash)

header('Content-Type: text/html; charset=utf-8');
date_default_timezone_set('America/Argentina/Buenos_Aires');

// Activa errores en pantalla mientras debugueamos (después se puede comentar)
error_reporting(E_ALL);
ini_set('display_errors', 1);

$dbFile = __DIR__ . '/save_the_rave.sqlite';

// ================ helpers ================

function db_connect_usuarios($dbFile)
{
    $pdo = new PDO('sqlite:' . $dbFile);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    return $pdo;
}

// Generar token compatible con PHP viejo
function generar_token()
{
    if (function_exists('random_bytes')) {
        return bin2hex(random_bytes(16));
    }
    return sha1(uniqid(mt_rand(), true));
}

// password_hash compatible
function tickex_password_hash($password)
{
    if (function_exists('password_hash')) {
        return password_hash($password, PASSWORD_BCRYPT);
    }
    // Fallback para PHP < 5.5 (no es lo ideal, pero alcanza para este sistema interno)
    return sha1('tickex_legacy_salt|' . $password);
}

// Enviar mail de confirmación + log
function enviar_correo_confirmacion($email, $nombre, $token)
{
    $fromEmail = 'no-reply@tickex.com.ar';
    $fromName  = 'Tickex';
    $from      = $fromName . ' <' . $fromEmail . '>';

    $link    = 'https://str.tickex.com.ar/verificar_email.php?token=' . urlencode($token);
    $subject = 'Confirmá tu email en Tickex';

    $body  = "Hola " . $nombre . ",\n\n";
    $body .= "Gracias por registrarte en Tickex.\n\n";
    $body .= "Para confirmar tu email y activar tu cuenta, hacé clic en este enlace:\n";
    $body .= $link . "\n\n";
    $body .= "Si no te registraste vos, podés ignorar este mensaje.\n\n";
    $body .= "Tickex\n";

    $headers  = "From: " . $from . "\r\n";
    $headers .= "Reply-To: " . $fromEmail . "\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion() . "\r\n";

    // Envelope sender (muy importante para que Exim/Postfix lo acepte bien)
    $extraParams = '-f ' . $fromEmail;

    $ok = mail($email, $subject, $body, $headers, $extraParams);

    // Log simple
    $logLine = date('c') . " registro_usuario mail to=" . $email . " ok=" . ($ok ? '1' : '0') . "\n";
    @file_put_contents(__DIR__ . '/log_mail_registro.txt', $logLine, FILE_APPEND);

    return $ok;
}

// ================ lógica de registro ================

$errores = array();
$exito   = false;
$mailOk  = null;

$nombre   = '';
$apellido = '';
$email    = '';
$dni      = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $nombre   = isset($_POST['nombre'])   ? trim($_POST['nombre'])   : '';
    $apellido = isset($_POST['apellido']) ? trim($_POST['apellido']) : '';
    $email    = isset($_POST['email'])    ? trim($_POST['email'])    : '';
    $dni      = isset($_POST['dni'])      ? trim($_POST['dni'])      : '';
    $pass1    = isset($_POST['password']) ? $_POST['password']       : '';
    $pass2    = isset($_POST['password2'])? $_POST['password2']      : '';

    // Validaciones básicas
    if ($nombre === '') {
        $errores[] = 'El nombre es obligatorio.';
    }
    if ($apellido === '') {
        $errores[] = 'El apellido es obligatorio.';
    }
    if ($email === '') {
        $errores[] = 'El email es obligatorio.';
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $errores[] = 'El email no tiene un formato válido.';
    }
    if ($dni === '') {
        $errores[] = 'El DNI es obligatorio.';
    }
    if ($pass1 === '' || $pass2 === '') {
        $errores[] = 'La contraseña y su repetición son obligatorias.';
    } elseif ($pass1 !== $pass2) {
        $errores[] = 'Las contraseñas no coinciden.';
    } elseif (strlen($pass1) < 6) {
        $errores[] = 'La contraseña debe tener al menos 6 caracteres.';
    }

    if (empty($errores)) {
        try {
            $pdo = db_connect_usuarios($dbFile);

            // Aseguramos la tabla por si acaso (coincidiendo con tu PRAGMA)
  
                CREATE TABLE IF NOT EXISTS usuarios (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    nombre TEXT NOT NULL,
                    apellido TEXT NOT NULL,
                    email TEXT NOT NULL,
                    dni TEXT NOT NULL,
                    password_hash TEXT NOT NULL,
                    rol TEXT NOT NULL DEFAULT 'cliente',
                    email_confirmado INTEGER NOT NULL DEFAULT 0,
                    token_confirmacion TEXT,
                    creado_en TEXT NOT NULL
                )
            ");

            // Chequear si ya existe un usuario con ese email
            $stCheck = $pdo->prepare("SELECT id FROM usuarios WHERE email = :email LIMIT 1");
            $stCheck->execute(array(':email' => $email));
            $existe = $stCheck->fetch(PDO::FETCH_ASSOC);

            if ($existe) {
                $errores[] = 'Ya existe un usuario registrado con ese email.';
            } else {
                $token   = generar_token();
                $hash    = tickex_password_hash($pass1);
                $creado  = date('Y-m-d H:i:s');
                $rol     = 'cliente';

                $stIns = $pdo->prepare("
                    INSERT INTO usuarios
                        (nombre, apellido, email, dni, password_hash, rol,
                         email_confirmado, token_confirmacion, creado_en)
                    VALUES
                        (:nombre, :apellido, :email, :dni, :pass_hash, :rol,
                         0, :token, :creado_en)
                ");

                $stIns->execute(array(
                    ':nombre'     => $nombre,
                    ':apellido'   => $apellido,
                    ':email'      => $email,
                    ':dni'        => $dni,
                    ':pass_hash'  => $hash,
                    ':rol'        => $rol,
                    ':token'      => $token,
                    ':creado_en'  => $creado,
                ));

                // Enviar mail de confirmación
                $mailOk = enviar_correo_confirmacion($email, $nombre . ' ' . $apellido, $token);
                $exito  = true;
            }

        } catch (Exception $e) {
            $errores[] = 'Error en el servidor: ' . $e->getMessage();
        }
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro de usuario – Tickex</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f7f7f7;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: #0b1020;
      border-radius: 16px;
      padding: 24px 28px;
      box-shadow: 0 12px 35px rgba(0,0,0,0.65);
      width: 100%;
      max-width: 440px;
      box-sizing: border-box;
    }
    .logo-wrap {
      text-align: center;
      margin-bottom: 16px;
    }
    .logo-wrap img {
      height: 230px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
      text-align: center;
    }
    .sub {
      font-size: 14px;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 3px;
      color: #e5e7eb;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      box-sizing: border-box;
      font-size: 14px;
    }
    input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }
    .btn {
      margin-top: 16px;
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#22c55e,#16a3ff);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
    }
    .btn:hover {
      opacity: 0.93;
    }
    .alert {
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .alert-error {
      background: rgba(220,38,38,0.15);
      border: 1px solid rgba(220,38,38,0.4);
      color: #fecaca;
    }
    .alert-ok {
      background: rgba(34,197,94,0.12);
      border: 1px solid rgba(34,197,94,0.4);
      color: #bbf7d0;
    }
    .small {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo-wrap">
      <img src="/tickex-logo_sobre_oscuro.svg" alt="Tickex">
    </div>

    <h1>Crear cuenta en Tickex</h1>
    <div class="sub">
      Registrate para poder recibir tus entradas por email y gestionar tus compras en Tickex.
    </div>

    <?php if (!empty($errores)): ?>
      <div class="alert alert-error">
        <?php foreach ($errores as $e): ?>
          <div>• <?php echo htmlspecialchars($e, ENT_QUOTES, 'UTF-8'); ?></div>
        <?php endforeach; ?>
      </div>
    <?php endif; ?>

    <?php if ($exito): ?>
      <div class="alert alert-ok">
        <strong>Revisá tu email</strong><br>
        Creamos tu usuario con el rol <strong>cliente</strong>.<br><br>
        Te enviamos un mensaje a <strong><?php echo htmlspecialchars($email, ENT_QUOTES, 'UTF-8'); ?></strong>
        con un enlace para confirmar tu cuenta.<br><br>
        Cuando hagas clic en el enlace de confirmación, tu email va a quedar validado y vas a poder recibir
        entradas y gestionar tus compras en Tickex.<br><br>
        Si no ves el mail en unos minutos, revisá la carpeta de spam / correo no deseado.
      </div>
    <?php else: ?>
      <form method="post" nov
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" name="nombre"
               value="<?php echo htmlspecialchars($nombre, ENT_QUOTES, 'UTF-8'); ?>" required>

        <label for="apellido">Apellido</label>
        <input type="text" id="apellido" name="apellido"
               value="<?php echo htmlspecialchars($apellido, ENT_QUOTES, 'UTF-8'); ?>" required>

        <label for="email">Email</label>
        <input type="email" id="email" name="email"
               value="<?php echo htmlspecialchars($email, ENT_QUOTES, 'UTF-8'); ?>" required>

        <label for="dni">DNI</label>
        <input type="text" id="dni" name="dni"
               value="<?php echo htmlspecialchars($dni, ENT_QUOTES, 'UTF-8'); ?>" required>

        <label for="password">Contraseña</label>
        <input type="password" id="password" name="password" required>

        <label for="password2">Repetir contraseña</label>
        <input type="password" id="password2" name="password2" required>

        <button class="btn" type="submit">Registrarme</button>

        <div class="small">
          Tu email se va a usar para enviarte las entradas y avisos importantes sobre tus compras.
        </div>
      </form>
    <?php endif; ?>
  </div>
</body>
</html>
