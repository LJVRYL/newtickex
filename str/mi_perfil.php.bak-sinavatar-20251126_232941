<?php
// mi_perfil.php - Perfil del admin (nombre, email, dni, cbu, avatar simple)

require __DIR__ . '/inc/bootstrap.php';
require_login();

$cu = current_user();

$tipoGlobal = isset($_SESSION['tipo_global'])
    ? $_SESSION['tipo_global']
    : (isset($cu['rol']) ? $cu['rol'] : '');

$userId = isset($cu['id'])
    ? (int)$cu['id']
    : (isset($_SESSION['user_id']) ? (int)$_SESSION['user_id'] : 0);

if ($userId <= 0) {
    http_response_code(403);
    $title = 'Sesion invalida';
    require __DIR__ . '/inc/layout_top.php';
    echo '<div class="card"><div class="alert alert-danger">Sesion invalida (falta user_id).</div></div>';
    require __DIR__ . '/inc/layout_bottom.php';
    exit;
}

// Conectar DB
try {
    $pdo = db();
} catch (Exception $e) {
    http_response_code(500);
    echo 'Error DB.';
    exit;
}

// Cargar usuario, incluyendo avatar_filename si existe
$user = null;
try {
    $stmt = $pdo->prepare(
        'SELECT id, username, nombre, email, dni, cbu, avatar_filename
         FROM usuarios_admin
         WHERE id = :id
         LIMIT 1'
    );
    $stmt->execute(array(':id' => $userId));
    $user = $stmt->fetch(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    http_response_code(500);
    echo 'Error cargando usuario.';
    exit;
}

if (!$user) {
    http_response_code(403);
    $title = 'Usuario no encontrado';
    require __DIR__ . '/inc/layout_top.php';
    echo '<div class="card"><div class="alert alert-danger">Usuario no encontrado.</div></div>';
    require __DIR__ . '/inc/layout_bottom.php';
    exit;
}

$error = '';
$okMsg = '';

// Procesar POST
if (isset($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] === 'POST') {

    $nombre = isset($_POST['nombre']) ? trim($_POST['nombre']) : '';
    $email  = isset($_POST['email'])  ? trim($_POST['email'])  : '';
    $dni    = isset($_POST['dni'])    ? trim($_POST['dni'])    : '';
    $cbu    = isset($_POST['cbu'])    ? trim($_POST['cbu'])    : '';

    if ($email !== '' && !filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $error = 'El email no tiene un formato valido.';
    }

    // Partimos del avatar actual, por si no se sube nada nuevo
    $avatarFilename = isset($user['avatar_filename']) ? $user['avatar_filename'] : null;

    // Manejo de avatar (opcional) basado en tmp_name, sin usar el codigo de error
    if ($error === '' && isset($_FILES['avatar']) && is_array($_FILES['avatar'])) {

        $tmpName = isset($_FILES['avatar']['tmp_name']) ? $_FILES['avatar']['tmp_name'] : '';
        $size    = isset($_FILES['avatar']['size']) ? (int)$_FILES['avatar']['size'] : 0;
        $name    = isset($_FILES['avatar']['name']) ? $_FILES['avatar']['name'] : '';

        // Solo intentamos algo si realmente vino un archivo
        if ($tmpName !== '' && is_uploaded_file($tmpName)) {

            if ($size > 2 * 1024 * 1024) {
                $error = 'La imagen de perfil no puede pesar mas de 2 MB.';
            } else {
                $info = @getimagesize($tmpName);
                if ($info === false) {
                    $error = 'El archivo subido no es una imagen valida.';
                } else {
                    // Validar por extension
                    $ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
                    if ($ext !== 'png' && $ext !== 'jpg' && $ext !== 'jpeg') {
                        $error = 'Solo se permiten imagenes PNG o JPG.';
                    } else {
                        $dir = __DIR__ . '/avatars';
                        if (!is_dir($dir)) {
                            @mkdir($dir, 0775, true);
                        }
                        $safeBase = preg_replace('/[^a-zA-Z0-9_\-\.]/', '_', $name);
                        $newName  = 'u' . (int)$user['id'] . '_' . time() . '_' . $safeBase;
                        $destPath = $dir . '/' . $newName;

                        if (!move_uploaded_file($tmpName, $destPath)) {
                      
                        } else {
                            $avatar
                        }
                    }
                }
            }
        }
        // Si no hay tmp_name, lo tomamos como "no subio imagen" y no marcamos error
    }

    // Si todo OK, guardar cambios
    if ($error === '') {
        try {
            $stmtUpd = $pdo->prepare(
                'UPDATE usuarios_admin
                 SET nombre = :nombre,
                     email  = :email,
                     dni    = :dni,
                     cbu    = :cbu,
                     avatar_filename = :avatar
                 WHERE id = :id'
            );
            $stmtUpd->execute(array(
                ':nombre' => ($nombre !== '' ? $nombre : null),
                ':email'  => ($email  !== '' ? $email  : null),
                ':dni'    => ($dni    !== '' ? $dni    : null),
                ':cbu'    => ($cbu    !== '' ? $cbu    : null),
                ':avatar' => $avatarFilename,
                ':id'     => (int)$user['id'],
            ));

            $okMsg = 'Perfil actualizado correctamente.';

            // Refrescar datos en memoria
            $user['nombre']          = $nombre;
            $user['email']           = $email;
            $user['dni']             = $dni;
            $user['cbu']             = $cbu;
            $user['avatar_filename'] = $avatarFilename;

        } catch (Exception $e) {
            $error = 'Error al guardar el perfil.';
        }
    }
}

// Layout
$title = 'Mi perfil';
require __DIR__ . '/inc/layout_top.php';
?>
<div class="card" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
  <a class="btn secondary" href="panel_admin.php">⬅ Volver al panel</a>
</div>

<div class="card">
  <h2>Mi perfil</h2>
  <div style="color:var(--muted);font-size:14px;">
    Usuario: <strong><?php echo e($user['username']); ?></strong>
    (<?php echo e($tipoGlobal); ?>)
  </div>
</div>

<?php if ($okMsg !== ''): ?>
  <div class="card">
    <div class="alert alert-success">
      <?php echo e($okMsg); ?>
    </div>
  </div>
<?php endif; ?>

<?php if ($error !== ''): ?>
  <div class="card">
    <div class="alert alert-danger">
      <?php echo e($error); ?>
    </div>
  </div>
<?php endif; ?>

<form method="post" enctype="multipart/form-data">
  <div class="card" style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;">

    <div style="flex:0 0 140px;text-align:center;">
      <?php if (!empty($user['avatar_filename'])): ?>
        <div style="margin-bottom:8px;">
          <img src="<?php echo e($user['avatar_filename']); ?>" alt="Avatar"
               style="width:120px;height:120px;object-fit:cover;border-radius:999px;border:2px solid rgba(148,163,184,0.5);">
        </div>
      <?php else: ?>
        <div style="width:120px;height:120px;border-radius:999px;background:#e5e7eb;color:#6b7280;display:flex;align-items:center;justify-content:center;margin-bottom:8px;font-size:36px;font-weight:bold;">
          <?php
            $ini = '';
            if (!empty($user['nombre'])) {
                $ini = strtoupper(substr($user['nombre'], 0, 1));
            } elseif (!empty($user['username'])) {
                $ini = strtoupper(substr($user['username'], 0, 1));
            } else {
                $ini = '?';
            }
            echo e($ini);
          ?>
        </div>
      <?php endif; ?>

      <label for="avatar" style="display:block;font-size:13px;margin-bottom:4px;">Foto de perfil</label>
      <input type="file" id="avatar" name="avatar" accept="image/png,image/jpeg"
             style="font-size:12px;">
      <div style="font-size:11px;color:var(--muted);margin-top:4px;">
        PNG/JPG, max. 2 MB.
      </div>
    </div>

    <div style="flex:1 1 260px;min-width:240px;">
      <label for="nombre">Nombre</label>
      <input type="text" id="nombre" name="nombre"
             value="<?php echo e($user['nombre']); ?>">

      <label for="email">Email</label>
      <input type="email" id="email" name="email"
             value="<?php echo e($user['email']); ?>">

      <label for="dni">DNI / Documento</label>
      <input type="text" id="dni" name="dni"
             value="<?php echo e($user['dni']); ?>">

      <label for="cbu">CBU / Cuenta para pagos</label>
      <input type="text" id="cbu" name="cbu"
             value="<?php echo e($user['cbu']); ?>">

      <button type="submit" class="btn" style="margin-top:12px;">
        Guardar cambios
      </button>
    </div>
  </div>
</form>

<div class="card">
  <h3>Seguridad</h3>
  <p style="margin-bottom:10px;font-size:14px;">
    Si necesitas cambiar tu contraseña, por ahora se hace por fuera del sistema (soporte/tecnico).
  </p>
  <p style="margin-top:8px;font-size:12px;color:var(--muted);">
    La opcion de recuperar contraseña se hace desde la pantalla de login, no desde aca.
  </p>
</div>

<?php
require __DIR__ . '/inc/layout_bottom.php';
