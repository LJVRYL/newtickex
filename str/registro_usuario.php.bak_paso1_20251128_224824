<?php
// registro_usuario.php – Registro público de clientes Tickex

require_once __DIR__.'/inc/bootstrap.php';

// NO pedimos login acá, es público

$title = 'Registro de usuario';

$errores   = array();
$mensajeOk = '';
$nombre    = '';
$apellido  = '';
$email     = '';
$dni       = '';

// --------- Función para enviar mail de confirmación ---------
function enviar_mail_confirmacion($email, $nombreCompleto, $token)
{
    $fromEmail = 'no-reply@tickex.com.ar';
    $fromName  = 'Tickex';
    $from      = $fromName . ' <' . $fromEmail . '>';

    $link    = 'https://str.tickex.com.ar/verificar_email.php?token=' . urlencode($token);
    $subject = 'Confirmá tu email en Tickex';

    $body  = "Hola " . $nombreCompleto . ",\n\n";
    $body .= "Gracias por registrarte en Tickex.\n\n";
    $body .= "Para confirmar tu email y activar tu cuenta, hacé clic en este enlace:\n";
    $body .= $link . "\n\n";
    $body .= "Si no te registraste vos, podés ignorar este mensaje.\n\n";
    $body .= "Tickex\n";

    $headers  = "From: " . $from . "\r\n";
    $headers .= "Reply-To: " . $fromEmail . "\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion() . "\r\n";

    // Envelope sender (-f) para que el MTA vea bien el remitente
    $extraParams = '-f ' . $fromEmail;

    $ok = mail($email, $subject, $body, $headers, $extraParams);

    // Log simple
    $logLine = date('c') . " registro_usuario mail to=" . $email . " ok=" . ($ok ? '1' : '0') . "\n";
    @file_put_contents(__DIR__ . '/log_mail_registro.txt', $logLine, FILE_APPEND);

    return $ok;
}

// --------- Procesar POST ---------
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $nombre   = isset($_POST['nombre'])   ? trim($_POST['nombre'])   : '';
    $apellido = isset($_POST['apellido']) ? trim($_POST['apellido']) : '';
    $email    = isset($_POST['email'])    ? trim($_POST['email'])    : '';
    $dni      = isset($_POST['dni'])      ? trim($_POST['dni'])      : '';
    $pass     = isset($_POST['pass'])     ? $_POST['pass']           : '';
    $pass2    = isset($_POST['pass2'])    ? $_POST['pass2']          : '';

    // Validaciones básicas
    if ($nombre === '') {
        $errores[] = 'El nombre es obligatorio.';
    }
    if ($apellido === '') {
        $errores[] = 'El apellido es obligatorio.';
    }
    if ($email === '') {
        $errores[] = 'El email es obligatorio.';
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $errores[] = 'El email no tiene un formato válido.';
    }
    if ($dni === '') {
        $errores[] = 'El DNI es obligatorio.';
    }
    if ($pass === '' || $pass2 === '') {
        $errores[] = 'Tenés que ingresar la contraseña dos veces.';
    } elseif ($pass !== $pass2) {
        $errores[] = 'Las contraseñas no coinciden.';
    } elseif (strlen($pass) < 6) {
        $errores[] = 'La contraseña debe tener al menos 6 caracteres.';
    }

    // Si no hay errores, intentamos grabar en DB
    if (empty($errores)) {
        try {
            $pdo = db();
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

            // ¿Email ya existe?
            $stEmail = $pdo->prepare("SELECT id FROM usuarios WHERE email = :email LIMIT 1");
            $stEmail->execute(array(':email' => $email));
            $ya = $stEmail->fetch(PDO::FETCH_ASSOC);
            if ($ya) {
                $errores[] = 'Ese email ya está registrado. Probá iniciar sesión o usar otro.';
            } else {
                // Hash de contraseña
                $passwordHash = password_hash($pass, PASSWORD_DEFAULT);

                // Token de confirmación
                if (function_exists('random_bytes')) {
                    $token = bin2hex(random_bytes(16));
                } else {
                    $token = sha1(uniqid(mt_rand(), true));
                }

                $ahora = date('Y-m-d H:i:s');

                // *** SQL en una sola línea, sin cosas raras ***
                $sql = "INSERT INTO usuarios (nombre, apellido, email, dni, password_hash, rol, email_confirm

                $stmt = $pdo->prepare($sql);
                $stmt->execute(array(
                    ':nombre'    => $nombre,
                    ':apellido'  => $apellido,
                    ':email'     => $email,
                    ':dni'       => $dni,
                    ':pass'      => $passwordHash,
                    ':token'     => $token,
                    ':creado_en' => $ahora
                ));

                $nombreCompleto = trim($nombre . ' ' . $apellido);
                $mailOk = enviar_mail_confirmacion($email, $nombreCompleto, $token);

                $mensajeOk = 'Creamos tu usuario con el rol cliente.'
                    . ' Te enviamos un mensaje a ' . htmlspecialchars($email, ENT_QUOTES, 'UTF-8')
                    . ' con un enlace para confirmar tu cuenta.';

                if (!$mailOk) {
                    $mensajeOk .= ' (Ojo: el servidor devolvió mail() = false, revisá la configuración del correo).';
                }

                // Opcional: limpiar campos del form
                $nombre   = '';
                $apellido = '';
                $email    = '';
                $dni      = '';
            }
        } catch (Exception $e) {
            $errores[] = 'Error al registrar el usuario: ' . $e->getMessage();
        }
    }
}

include __DIR__.'/inc/layout_top.php';
?>
<div class="card" style="max-width:480px;margin:0 auto 16px auto;text-align:center;">
  <div style="margin-bottom:16px;">
    <img src="tickex-logo_sobre_oscuro.svg"
         alt="Tickex"
         style="height:230px;display:block;margin:0 auto 8px auto;">
  </div>
  <h2>Registrate en Tickex</h2>
  <p style="color:var(--muted);margin-top:8px;">
    Registrate para poder recibir tus entradas por email y gestionar tus compras en Tickex.
  </p>
</div>

<?php if (!empty($errores)): ?>
  <div class="card" style="max-width:480px;margin:0 auto 16px auto;">
    <div class="flash err">
      <ul style="margin:0 0 0 18px;padding:0;">
        <?php foreach ($errores as $e): ?>
          <li><?php echo htmlspecialchars($e, ENT_QUOTES, 'UTF-8'); ?></li>
        <?php endforeach; ?>
      </ul>
    </div>
  </div>
<?php endif; ?>

<?php if ($mensajeOk !== ''): ?>
  <div class="card" style="max-width:480px;margin:0 auto 16px auto;">
    <div class="flash ok">
      <strong>Revisá tu email</strong><br><br>
      <?php echo $mensajeOk; ?><br><br>
      Si no ves el mail en unos minutos, revisá la carpeta de spam / correo no deseado.
    </div>
  </div>
<?php endif; ?>

<div class="card" style="max-width:480px;margin:0 auto 32px auto;">
  <form method="post" autocomplete="off">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div>
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" name="nombre" required
               value="<?php echo htmlspecialchars($nombre, ENT_QUOTES, 'UTF-8'); ?>">
      </div>
      <div>
        <label for="apellido">Apellido</label>
        <input type="text" id="apellido" name="apellido" required
               value="<?php echo htmlspecialchars($apellido, ENT_QUOTES, 'UTF-8'); ?>">
      </div>
    </div>

    <label for="email" style="margin-top:8px;display:block;">Email</label>
    <input type="email" id="email" name="email" required
           value="<?php echo htmlspecialchars($email, ENT_QUOTES, 'UTF-8'); ?>">

    <label for="dni" style="margin-top:8px;display:block;">DNI</label>
    <input type="text" id="dni" name="dni" required
           value="<?php echo htmlspecialchars($dni, ENT_QUOTES, 'UTF-8'); ?>">

    <label for="pass" style="margin-top:8px;display:block;">Contraseña</label>
    <input type="password" id="pass" name="pass" required>

    <label for="pass2" style="margin-top:8px;display:block;">Repetir contraseña</label>
    <input type="password" id="pass2" name="pass2" required>

    <button class="btn" type="submit" style="width:100%;margin-top:16px;">
      Registrarme
    </button>
  </form>
</div>

<?php include __DIR__.'/inc/layout_bottom.php'; ?>
