                           [ "enviar_email_confirmacion" no encontrado ]
<?php
// registro_usuario.php – registro de usuarios finales (clientes)

date_default_timezone_set('America/Argentina/Buenos_Aires');

$dbFile = __DIR__ . '/save_the_rave.sqlite';

// Función simple para escapar HTML
function h($s) {
    return htmlspecialchars($s, ENT_QUOTES, 'UTF-8');
}

$errores = array();
$ok = false;
$mailEnviado = false;

// Valores por defecto para repoblar el form si hay errores
$nombre    = '';
$apellido  = '';
$email     = '';
$dni       = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $nombre    = isset($_POST['nombre'])    ? trim($_POST['nombre'])    : '';
    $apellido  = isset($_POST['apellido'])  ? trim($_POST['apellido'])  : '';
    $email     = isset($_POST['email'])     ? trim($_POST['email'])     : '';
    $dni       = isset($_POST['dni'])       ? trim($_POST['dni'])       : '';
    $pass1     = isset($_POST['password'])  ? $_POST['password']        : '';
    $pass2     = isset($_POST['password2']) ? $_POST['password2']       : '';

    // Validaciones básicas
    if ($nombre === '') {
        $errores[] = 'El nombre es obligatorio.';
    }
    if ($apellido === '') {
        $errores[] = 'El apellido es obligatorio.';
    }
    if ($email === '') {
        $errores[] = 'El email es obligatorio.';
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $errores[] = 'El email no tiene un formato válido.';
    }

    if ($dni === '') {
        $errores[] = 'El DNI es obligatorio.';
    }

    if ($pass1 === '' || $pass2 === '') {
        $errores[] = 'Tenés que escribir la contraseña dos veces.';
    } elseif ($pass1 !== $pass2) {
        $errores[] = 'Las contraseñas no coinciden.';
    } elseif (strlen($pass1) < 6) {
        $errores[] = 'La contraseña debe tener al menos 6 caracteres.';
    }

    if (empty($errores)) {
        try {
            $pdo = new PDO('sqlite:' . $dbFile);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

            // ¿Ya existe ese email?
            $st = $pdo->prepare("SELECT id FROM usuarios WHERE email = :email LIMIT 1");
            $st->execute(array(':email' => $email));
            if ($st->fetch(PDO::FETCH_ASSOC)) {
                $errores[] = 'Ya existe un usuario registrado con ese email.';
            }
        } catch (Exception $e) {
            $errores[] = 'Error al conectar con la base de datos: ' . $e->getMessage();
        }
    }

    if (empty($errores)) {
        try {
            // Hash de contraseña (soporta ambientes viejos)
            if (function_exists('password_hash')) {
                $passHash = password_hash($pass1, PASSWORD_DEFAULT);
            } else {
                $passHash = sha1('tickex_salt_' . $pass1);
            }

            // Token de confirmación
            if (function_exists('random_bytes')) {
                $token = bin2hex(random_bytes(16));
            } elseif (function_exists('openssl_random_pseudo_bytes')) {
                $token = bin2hex(openssl_random_pseudo_bytes(16));
            } else {
                $token = sha1(uniqid('', true));
            }

            $ahora = date('Y-m-d H:i:s');

            $stmt = $pdo->prepare("
                INSERT INTO usuarios
                    (nombre, apellido, email, dni, password_hash, rol, email_confirmado, token_confirmacion, creado_en)
                VALUES
                    (:nombre, :apellido, :email, :dni, :pass_hash, :rol, :email_conf, :token, :creado)
            ");

            $stmt->execute(array(
                ':nombre'      => $nombre,
                ':apellido'    => $apellido,
                ':email'       => $email,
                ':dni'         => $dni,
                ':pass_hash'   => $passHash,
                ':rol'         => 'cliente',
                ':email_conf'  => 0,
                ':token'       => $token,
                ':creado'      => $ahora
            ));

            // Enviar mail de confirmación
            $confirmUrl = 'https://str.tickex.com.ar/verificar_email.php?token=' . urlencode($token);

            $fromEmail = 'no-reply@tickex.com.ar';
            $subject   = 'Confirmá tu email en Tickex';
            $body  = "Hola " . $nombre . ",\n\n";
            $body .= "Gracias por registrarte en Tickex.\n\n";
            $body .= "Para confirmar tu email y activar tu cuenta, hacé clic en este enlace:\n";
            $body .= $confirmUrl . "\n\n";
            $body .= "Si vos no iniciaste este registro, podés ignorar este mensaje.\n\n";
            $body .= "Tickex\n";
            $body .= "https://tickex.com.ar\n";

            $headers  = "From: Tickex <" . $fromEmail . ">\r\n";
            $headers .= "Reply-To: " . $fromEmail . "\r\n";
            $headers .= "X-Mailer: PHP/" . phpversion() . "\r\n";

            // MUY IMPORTANTE: envelope sender -f
            $mailEnviado = mail($email, $subject, $body, $headers, '-f ' . $fromEmail);

            $ok = true;

        } catch (Exception $e) {
            $errores[] = 'Error al crear el usuario: ' . $e->getMessage();
        }
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro de usuario – Tickex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #050816;
      --card-bg: #0b1020;
      --accent: #ffcc33;
      --accent-soft: rgba(255,204,51,0.08);
      --text: #f7fafc;
      --text-muted: #a0aec0;
      --error: #f56565;
      --ok: #48bb78;
      --input-bg: #111827;
      --border: #2d3748;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top, #1a202c 0, #050816 55%, #020308 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
    }
    .wrapper {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 20px 22px 24px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.8);
      border: 1px solid rgba(148,163,184,0.25);
    }
    .logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 18px;
    }
    .logo-wrap img {
      height: 230px; /* ×5 como pediste */
      max-width: 100%;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
      text-align: center;
    }
    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 18px;
    }
    form {
      margin-top: 4px;
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      margin-bottom: 10px;
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,204,51,0.5);
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .row > div {
      flex: 1 1 0;
    }
    .btn {
      width: 100%;
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ffcc33, #f6ad55);
      color: #1a202c;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }
    .btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(0,0,0,0.6);
    }
    .alert {
      font-size: 13px;
      border-radius: 10px;
      padding: 10px 11px;
      margin-bottom: 12px;
    }
    .alert.error {
      background: rgba(245,101,101,0.1);
      border: 1px solid rgba(245,101,101,0.6);
      color: #fed7d7;
    }
    .alert.ok {
      background: rgba(72,187,120,0.1);
      border: 1px solid rgba(72,187,120,0.6);
      color: #c6f6d5;
    }
    .alert ul {
      margin: 4px 0 0 18px;
      padding: 0;
    }
    .small {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 10px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="logo-wrap">
      <img src="tickex-logo_sobre_oscuro.svg" alt="Tickex">
    </div>

    <div class="card">
      <?php if ($ok): ?>
        <h1>Revisá tu email</h1>
        <p class="subtitle">
          Creamos tu usuario con el rol <strong>cliente</strong>.
        </p>
        <div class="alert ok">
          Te enviamos un mensaje a <strong><?php echo h($email); ?></strong> con un enlace para confirmar tu cuenta.
          <br><br>
          Cuando hagas clic en el enlace de confirmación, tu email va a quedar validado y vas a poder recibir entradas y gestionar tus compras en Tickex.
          <br><br>
          <?php if (!$mailEnviado): ?>
            <strong>Atención:</strong> mail() devolvió <code>false</code> en el servidor. Es posible que el correo no se haya podido enviar. Consultá con el soporte técnico si el mail no llega.
          <?php else: ?>
            Si no ves el mail en unos minutos, revisá la carpeta de spam / correo no deseado.
          <?php endif; ?>
        </div>
      <?php else: ?>
        <h1>Crear cuenta en Tickex</h1>
        <p class="subtitle">
          Registrate para poder recibir tus entradas por email y gestionar tus compras en Tickex.
        </p>

        <?php if (!empty($errores)): ?>
          <div class="alert error">
            <strong>Revisá estos datos:</strong>
            <ul>
              <?php foreach ($errores as $e): ?>
                <li><?php echo h($e); ?></li>
              <?php endforeach; ?>
            </ul>
          </div>
        <?php endif; ?>

        <form method="post" autocomplete="off">
          <div class="row">
            <div>
              <label for="nombre">Nombre</label>
              <input type="text" id="nombre" name="nombre" required value="<?php echo h($nombre); ?>">
            </div>
            <div>
              <label for="apellido">Apellido</label>
              <input type="text" id="apellido" name="apellido" required value="<?php echo h($apellido); ?>">
            </div>
          </div>

          <label for="email">Email</label>
          <input type="email" id="email" name="email" required value="<?php echo h($email); ?>">

          <label for="dni">DNI</label>
          <input type="text" id="dni" name="dni" required value="<?php echo h($dni); ?>">

          <div class="row">
            <div>
              <label for="password">Contraseña</label>
              <input type="password" id="password" name="password" required>
            </div>
            <div>
              <label for="password2">Repetir contraseña</label>
              <input type="password" id="password2" name="password2" required>
            </div>
          </div>

          <button class="btn" type="submit">Registrarme</button>

          <p class="small">
            Usamos tu email solo para enviarte tus entradas, recordatorios y comunicaciones relacionadas a tus compras en Tickex.
          </p>
        </form>
      <?php endif; ?>
    </div>
  </div>
</body>
</html>
