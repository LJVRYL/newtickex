<?php
// registro_usuario.php – Registro de clientes (usuarios finales Tickex)
date_default_timezone_set('America/Argentina/Buenos_Aires');

$dbFile = __DIR__ . '/save_the_rave.sqlite';

try {
    $pdo = new PDO('sqlite:' . $dbFile);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (Exception $e) {
    http_response_code(500);
    echo "Error de base de datos.";
    exit;
}

function h($s) {
    return htmlspecialchars($s, ENT_QUOTES, 'UTF-8');
}

// ------------------------------
// Función: enviar email confirmación + logging
// ------------------------------
function enviar_email_confirmacion($email, $nombreCompleto, $token) {
    $fromEmail = 'no-reply@tickex.com.ar';
    $fromName  = 'Tickex';
    $from      = $fromName . ' <' . $fromEmail . '>';

    $link    = 'https://str.tickex.com.ar/verificar_email.php?token=' . urlencode($token);
    $subject = 'Confirmá tu email en Tickex';

    $body  = "Hola " . $nombreCompleto . ",\n\n";
    $body .= "Gracias por registrarte en Tickex.\n\n";
    $body .= "Para confirmar tu email y activar tu cuenta, hacé clic en este enlace:\n";
    $body .= $link . "\n\n";
    $body .= "Si no te registraste vos, podés ignorar este mensaje.\n\n";
    $body .= "Tickex\n";

    $headers  = "From: " . $from . "\r\n";
    $headers .= "Reply-To: " . $fromEmail . "\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion() . "\r\n";

    // envelope sender (muy importante para tickex.com.ar)
    $extraParams = '-f ' . $fromEmail;

    $ok = mail($email, $subject, $body, $headers, $extraParams);

    $logLine = date('c') . " registro_usuario mail to=" . $email . " ok=" . ($ok ? '1' : '0') . "\n";
    @file_put_contents(__DIR__ . '/log_mail_registro.txt', $logLine, FILE_APPEND);

    return $ok;
}

// ------------------------------
// Lógica de registro
// ------------------------------
$errores = array();
$okRegistro = false;

$nombre    = '';
$apellido  = '';
$email     = '';
$dni       = '';
$pass1     = '';
$pass2     = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $nombre   = isset($_POST['nombre'])   ? trim($_POST['nombre'])   : '';
    $apellido = isset($_POST['apellido']) ? trim($_POST['apellido']) : '';
    $email    = isset($_POST['email'])    ? trim($_POST['email'])    : '';
    $dni      = isset($_POST['dni'])      ? trim($_POST['dni'])      : '';
    $pass1    = isset($_POST['password']) ? $_POST['password']       : '';
    $pass2    = isset($_POST['password2'])? $_POST['password2']      : '';

    // Validaciones
    if ($nombre === '') {
        $errores[] = 'El nombre es obligatorio.';
    }
    if ($apellido === '') {
        $errores[] = 'El apellido es obligatorio.';
    }
    if ($email === '') {
        $errores[] = 'El email es obligatorio.';
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $errores[] = 'El email no tiene un formato válido.';
    }
    if ($dni === '') {
        $errores[] = 'El DNI es obligatorio.';
    }
    if ($pass1 === '' || $pass2 === '') {
        $errores[] = 'Tenés que ingresar la contraseña dos veces.';
    } elseif ($pass1 !== $pass2) {
        $errores[] = 'Las contraseñas no coinciden.';
    } elseif (strlen($pass1) < 6) {
        $errores[] = 'La contraseña debe tener al menos 6 caracteres.';
    }

    if (empty($errores)) {
        // ¿email ya existe?
        $st = $pdo->prepare("SELECT id FROM usuarios WHERE email = :email LIMIT 1");
        $st->execute(array(':email' => $email));
        $existe = $st->fetch(PDO::FETCH_ASSOC);

        if ($existe) {
            $errores[] = 'Ya existe un usuario registrado con ese email.';
        }
    }

    if (empty($errores)) {
        // Crear usuario
        $token = function_exists("random_bytes") ? bin2hex(random_bytes(16)) : sha1(uniqid(mt_rand(), true));
        $hash  = password_hash($pass1, PASSWORD_DEFAULT);
        $ahora = date('Y-m-d H:i:s');

        $stIns = $pdo->prepare("
            INSERT INTO usuarios
                (nombre, apellido, email, dni, password_hash, rol, email_confirmado, token_confirmacion, creado_en)
            VALUES
            
        ");
        $stIns->execute(array(
            ':nombre' => $nombre,
            ':apellido' => $apellido,
            ':email' => $email,
            ':dni' => $dni,
            ':pass' => $hash,
            ':rol' => 'cliente',
            ':token' => $token,
            ':creado' => $ahora,
        ));

        // Enviar mail de confirmación
        $nombreCompleto = trim($nombre . ' ' . $apellido);
        enviar_email_confirmacion($email, $nombreCompleto, $token);

        $okRegistro = true;
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro de usuario - Tickex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      --bg: #050509;
      --card-bg: #11131a;
      --border: #222;
      --text: #f4f4f7;
      --muted: #9a9ab0;
      --accent: #ff3b6b;
      --accent-soft: rgba(255,59,107,0.15);
      --danger: #ff4c4c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #191b2a 0, #050509 55%, #010104 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card {
      width: 100%;
      max-width: 460px;
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 24px 24px 28px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.7);
    }
    .logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }
    .logo-wrap img {
      height: 230px;
      display: block;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
    }
    .sub {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 18px;
    }
    label {
      font-size: 13px;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #333749;
      background: #050711;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 10px;
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,59,107,0.5);
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row > div { flex: 1; }
    .btn {
      width: 100%;
      margin-top: 16px;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #ff7b3b);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
    }
    .btn:hover {
      filter: brightness(1.05);
    }
    .err {
      background: rgba(255,76,76,0.08);
      border: 1px solid rgba(255,76,76,0.7);
      color: #ffd9d9;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .ok {
      background: var(--accent-soft);
      border: 1px solid rgba(255,59,107,0.7);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .ok-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .ok p {
      margin: 0 0 4px;
    }
    .ok small {
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo-wrap">
      <img src="/tickex-logo_sobre_oscuro.svg" alt="Tickex">
    </div>

    <?php if ($okRegistro): ?>
      <div class="ok">
        <div class="ok-title">Revisá tu email</div>
        <p>Creamos tu usuario con el rol <strong>cliente</strong>.</p>
        <p>Te enviamos un mensaje a <strong><?php echo h($email); ?></strong> con un enlace para confirmar tu cuenta.</p>
        <small>
          Cuando hagas clic en el enlace de confirmación, tu email va a quedar validado y vas a poder recibir entradas
          y gestionar tus compras en Tickex.<br>
          Si no ves el mail en unos minutos, revisá la carpeta de spam / correo no deseado.
        </small>
      </div>
    <?php else: ?>
      <?php if (!empty($errores)): ?>
        <div class="err">
          <?php foreach ($errores as $e): ?>
            • <?php echo h($e); ?><br>
          <?php endforeach; ?>
        </div>
      <?php endif; ?>

      <h1>Creá tu cuenta Tickex</h1>
      <div class="sub">
        Registrate para poder recibir tus entradas por email y gestionar tus compras en Tickex.
      </div>

      <form method="post" autocomplete="off">
        <div class="row">
          <div>
            <label for="nombre">Nombre</label>
            <input type="text" name="nombre" id="nombre" value="<?php echo h($nombre); ?>" required>
          </div>
          <div>
            <label for="apellido">Apellido</label>
            <input type="text" name="apellido" id="apellido" value="<?php echo h($apellido); ?>" required>
          </div>
        </div>

        <label for="email">Email</label>
        <input type="email" name="email" id="email" value="<?php echo h($email); ?>" required>

        <label for="dni">DNI</label>
        <input type="text" name="dni" id="dni" value="<?php echo h($dni); ?>" required>

        <div class="row">
          <div>
            <label for="password">Contraseña</label>
            <input type="password" name="password" id="password" required>
          </div>
          <div>
            <label for="password2">Repetir contraseña</label>
            <input type="password" name="password2" id="password2" required>
          </div>
        </div>

        <button class="btn" type="submit">Registrarme</button>
      </form>
    <?php endif; ?>
  </div>
</body>
</html>
